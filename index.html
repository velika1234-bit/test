<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LessonMaster Live (Test v2)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { -webkit-font-smoothing: antialiased; }
    .card { border: 1px solid rgb(226 232 240); border-radius: 1.5rem; background: white; box-shadow: 0 10px 25px rgba(0,0,0,.06); }
    .btn { border-radius: 1rem; font-weight: 800; letter-spacing: .08em; text-transform: uppercase; }
    .btn:active { transform: translateY(1px); }
    .muted { color: rgb(100 116 139); }
    .pill { border: 1px solid rgb(226 232 240); border-radius: 999px; padding: .25rem .6rem; font-size: .75rem; font-weight: 800; letter-spacing: .12em; text-transform: uppercase; color: rgb(100 116 139); }
    .opt { border: 2px solid rgb(226 232 240); border-radius: 1rem; padding: 1rem; font-weight: 800; background: white; }
    .opt.selected { border-color: rgb(2 132 199); background: rgb(240 249 255); }
    .disabled { opacity: .6; pointer-events: none; }
    code { background: rgb(241 245 249); padding: .1rem .25rem; border-radius: .4rem; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen">
  <div class="max-w-6xl mx-auto p-6 space-y-6">

    <!-- TOP BAR -->
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <div class="text-3xl font-black tracking-tight">LessonMaster Live (Test v2)</div>
        <div class="muted font-bold text-sm">Lesson –æ—Ç–¥–µ–ª–Ω–æ –æ—Ç Session ‚Ä¢ —É—á–µ–Ω–∏—Ü–∏ –≤–∏–∂–¥–∞—Ç —Å–∞–º–æ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏—Ç–µ</div>
      </div>
      <div class="flex gap-2 flex-wrap">
        <span id="mode-pill" class="pill">MODE: ‚Äî</span>
        <span id="status-pill" class="pill">STATUS: ‚Äî</span>
      </div>
    </header>

    <!-- SCREEN: WELCOME -->
    <section id="screen-welcome" class="grid md:grid-cols-2 gap-6">
      <!-- STUDENT -->
      <div class="card p-6 space-y-4">
        <div class="text-xl font-black">–£—á–µ–Ω–∏–∫</div>
        <div class="muted font-bold text-sm">–í–ª–∏–∑–∞—à —Å PIN –∏ —á–∞–∫–∞—à –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏—Ç–µ –¥–µ–π–Ω–æ—Å—Ç–∏.</div>

        <div class="space-y-2">
          <label class="text-xs font-black uppercase tracking-widest muted">–ò–º–µ</label>
          <input id="student-name" class="w-full p-4 rounded-2xl border-2 border-slate-200 font-bold outline-none focus:border-sky-600" placeholder="–ù–∞–ø—Ä. –ú–∞—Ä–∏—è" />
        </div>

        <div class="space-y-2">
          <label class="text-xs font-black uppercase tracking-widest muted">PIN</label>
          <input id="student-pin" class="w-full p-4 rounded-2xl border-2 border-slate-200 font-black text-2xl tracking-[.2em] outline-none focus:border-sky-600" placeholder="1234" inputmode="numeric" />
        </div>

        <button id="btn-student-join" class="btn w-full py-4 bg-sky-600 hover:bg-sky-700 text-white">–í–ª–µ–∑</button>

        <div class="muted text-xs font-bold">
          –ê–∫–æ –æ—Ç–≤–æ—Ä–∏—à –ª–∏–Ω–∫–∞ —Å <code>?pin=1234</code>, PIN —Å–µ –ø–æ–ø—ä–ª–≤–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.
        </div>
      </div>

      <!-- HOST -->
      <div class="card p-6 space-y-4 bg-slate-900 text-white border-0">
        <div class="text-xl font-black">–•–æ—Å—Ç (—É—á–∏—Ç–µ–ª)</div>
        <div class="text-slate-300 font-bold text-sm">–°—Ç–∞—Ä—Ç–∏—Ä–∞—à —Å–µ—Å–∏—è –∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–∞—à —Ç–µ–º–ø–æ—Ç–æ (Start / Next / Lock / Reveal).</div>

        <div class="space-y-2">
          <label class="text-xs font-black uppercase tracking-widest text-slate-400">–ü–∞—Ä–æ–ª–∞ (—Ç–µ—Å—Ç)</label>
          <input id="teacher-pass" type="password" class="w-full p-4 rounded-2xl bg-white/10 border-2 border-white/10 font-bold outline-none focus:border-sky-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>

        <div class="grid grid-cols-2 gap-3">
          <button id="btn-host-login" class="btn py-4 bg-sky-600 hover:bg-sky-500 text-white">–í—Ö–æ–¥</button>
          <button id="btn-load-demo" class="btn py-4 bg-white/10 hover:bg-white/15 text-white">Demo —É—Ä–æ–∫</button>
        </div>

        <div class="text-slate-300 text-xs font-bold">
          Demo —É—Ä–æ–∫—ä—Ç –µ –≤–≥—Ä–∞–¥–µ–Ω. –í —Å–ª–µ–¥–≤–∞—â –µ—Ç–∞–ø —â–µ –≥–æ –∑–∞–º–µ–Ω–∏–º —Å —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞.
        </div>
      </div>
    </section>

    <!-- SCREEN: HOST -->
    <section id="screen-host" class="hidden space-y-6">
      <div class="card p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div class="space-y-1">
            <div class="text-sm font-black uppercase tracking-widest muted">–°–µ—Å–∏—è</div>
            <div class="text-4xl font-black tracking-tight">
              PIN: <span id="host-pin" class="text-sky-700">‚Äî</span>
            </div>
            <div class="muted font-bold text-sm">
              Join link:
              <span id="host-join-link" class="font-black break-all"></span>
            </div>
            <div class="muted font-bold text-xs">
              lessonId: <span id="host-lesson-id" class="font-black">‚Äî</span>
            </div>
          </div>

          <div class="flex gap-2 flex-wrap">
            <button id="btn-host-start" class="btn px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white">Start</button>
            <button id="btn-host-next" class="btn px-6 py-3 bg-slate-800 hover:bg-black text-white">Next</button>
            <button id="btn-host-lock" class="btn px-6 py-3 bg-amber-500 hover:bg-amber-600 text-white">Lock</button>
            <button id="btn-host-reveal" class="btn px-6 py-3 bg-sky-600 hover:bg-sky-700 text-white">Reveal</button>
            <button id="btn-host-end" class="btn px-6 py-3 bg-rose-500 hover:bg-rose-600 text-white">End</button>
          </div>
        </div>
      </div>

      <div class="grid lg:grid-cols-3 gap-6">
        <!-- Host Slide -->
        <div class="lg:col-span-2 card p-6 min-h-[420px]">
          <div class="flex items-center justify-between">
            <div class="space-y-1">
              <div class="pill inline-block">HOST VIEW</div>
              <div id="host-slide-title" class="text-2xl font-black mt-3">‚Äî</div>
              <div id="host-slide-meta" class="muted font-bold text-sm">‚Äî</div>
            </div>
            <div class="text-right">
              <div class="muted text-xs font-black uppercase tracking-widest">–°–ª–∞–π–¥</div>
              <div id="host-slide-counter" class="text-2xl font-black">‚Äî</div>
            </div>
          </div>

          <div id="host-slide-body" class="mt-6 text-lg font-bold leading-relaxed muted">
            –°—Ç–∞—Ä—Ç–∏—Ä–∞–π —Å–µ—Å–∏—è –∏ –Ω–∞—Ç–∏—Å–Ω–∏ Start.
          </div>
        </div>

        <!-- Stats -->
        <div class="card p-6">
          <div class="pill inline-block mb-4">LIVE STATS</div>

          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <div class="muted font-black uppercase tracking-widest text-xs">–£—á–µ–Ω–∏—Ü–∏</div>
              <div id="stat-participants" class="text-xl font-black">0</div>
            </div>

            <div class="flex items-center justify-between">
              <div class="muted font-black uppercase tracking-widest text-xs">–û—Ç–≥–æ–≤–æ—Ä–∏–ª–∏</div>
              <div id="stat-answered" class="text-xl font-black">0</div>
            </div>

            <div class="mt-4 border-t pt-4">
              <div class="muted font-black uppercase tracking-widest text-xs mb-2">MCQ —Ä–∞–∑–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</div>
              <div id="stat-mcq" class="space-y-2 muted font-bold text-sm">
                <div>‚Äî</div>
              </div>
            </div>

            <div class="mt-4 border-t pt-4">
              <div class="muted font-black uppercase tracking-widest text-xs mb-2">Short –æ—Ç–≥–æ–≤–æ—Ä–∏</div>
              <div id="stat-short" class="space-y-2 text-sm">
                <div class="muted font-bold">‚Äî</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- SCREEN: STUDENT -->
    <section id="screen-student" class="hidden space-y-6">
      <div class="card p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <div class="pill inline-block">STUDENT VIEW</div>
            <div class="text-2xl font-black mt-3">PIN: <span id="student-pin-active" class="text-sky-700">‚Äî</span></div>
            <div class="muted font-bold text-sm">–ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–∑–ª–∏–∑–∞—Ç —Å–∞–º–æ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏—Ç–µ —Å–ª–∞–π–¥–æ–≤–µ.</div>
          </div>
          <button id="btn-student-leave" class="btn px-6 py-3 bg-slate-800 hover:bg-black text-white">–ò–∑—Ö–æ–¥</button>
        </div>
      </div>

      <!-- Waiting -->
      <div id="student-waiting" class="card p-10 text-center">
        <div class="text-6xl mb-4">üëÄ</div>
        <div id="student-waiting-msg" class="text-2xl font-black">–ì–ª–µ–¥–∞–π –µ–∫—Ä–∞–Ω–∞ –æ—Ç–ø—Ä–µ–¥‚Ä¶</div>
        <div class="muted font-bold mt-2">–ö–æ–≥–∞—Ç–æ –∑–∞–ø–æ—á–Ω–µ –¥–µ–π–Ω–æ—Å—Ç, —Ç—É–∫ —â–µ —Å–µ –ø–æ—è–≤–∏.</div>
      </div>

      <!-- Interaction -->
      <div id="student-interaction" class="hidden card p-6">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="pill inline-block">–ê–ö–¢–ò–í–ù–ê –î–ï–ô–ù–û–°–¢</div>
            <div id="student-q-title" class="text-2xl font-black mt-3">‚Äî</div>
            <div id="student-q-sub" class="muted font-bold text-sm mt-1">‚Äî</div>
          </div>
          <div class="text-right">
            <div class="muted text-xs font-black uppercase tracking-widest">–°—Ç–∞—Ç—É—Å</div>
            <div id="student-phase" class="text-xl font-black">‚Äî</div>
          </div>
        </div>

        <div id="student-q-body" class="mt-6"></div>

        <div class="mt-6 flex gap-3">
          <button id="btn-student-submit" class="btn flex-1 py-4 bg-sky-600 hover:bg-sky-700 text-white">–ü–æ—Ç–≤—ä—Ä–¥–∏</button>
        </div>

        <div id="student-sent" class="hidden mt-4 p-4 rounded-2xl bg-emerald-50 text-emerald-700 font-black">
          –ò–∑–ø—Ä–∞—Ç–µ–Ω–æ ‚úÖ
        </div>
      </div>
    </section>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp,
      collection, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // === CONFIG ===
    const appId = 'lessonmaster-live-test';
    let firebaseConfig;
    try { firebaseConfig = JSON.parse(__firebase_config); }
    catch (e) {
      firebaseConfig = {
        apiKey: "AIzaSyA0WhbnxygznaGCcdxLBHweZZThezUO314",
        authDomain: "videoquiz-ultimate.firebaseapp.com",
        projectId: "videoquiz-ultimate",
        storageBucket: "videoquiz-ultimate.firebasestorage.app",
        messagingSenderId: "793138692820",
        appId: "1:793138692820:web:8ee2418d28d47fca6bf141"
      };
    }

    const TEACHER_PASSWORD = 'vilidaf76'; // —Ç–µ—Å—Ç–æ–≤–æ

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Firestore paths (artifacts/appId/public/data)
    const sessionDocRef = (pin) => doc(db, 'artifacts', appId, 'public', 'data', 'sessions', pin);
    const lessonsDocRef = (lessonId) => doc(db, 'artifacts', appId, 'public', 'data', 'lessons', lessonId);

    const participantsColRef = (pin) => collection(db, 'artifacts', appId, 'public', 'data', 'sessions', pin, 'participants');
    const participantDocRef = (pin, uid) => doc(db, 'artifacts', appId, 'public', 'data', 'sessions', pin, 'participants', uid);

    const answersColRef = (pin, slideIdx) => collection(db, 'artifacts', appId, 'public', 'data', 'sessions', pin, 'responses', String(slideIdx), 'answers');
    const answerDocRef = (pin, slideIdx, uid) => doc(db, 'artifacts', appId, 'public', 'data', 'sessions', pin, 'responses', String(slideIdx), 'answers', uid);

    // === DEMO LESSON ===
    const demoLesson = {
      title: 'Demo: –í—ä–∑—Ä–∞–∂–¥–∞–Ω–µ (—Ç–µ—Å—Ç)',
      slides: [
        { title: '–í—ä–≤–µ–¥–µ–Ω–∏–µ', body: '–î–Ω–µ—Å –≥–æ–≤–æ—Ä–∏–º –∑–∞‚Ä¶ (—Å–∞–º–æ –Ω–∞ –µ–∫—Ä–∞–Ω–∞ –æ—Ç–ø—Ä–µ–¥)', visibility: 'host' },
        { title: 'MCQ: –ö–æ–µ –µ –≤—è—Ä–Ω–æ?', body: '–ò–∑–±–µ—Ä–∏ 1 –≤–µ—Ä–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä.', visibility: 'students',
          interaction: { kind: 'mcq', options: ['–ê', '–ë', '–í', '–ì'], correct: 2, points: 1 }
        },
        { title: '–û–±—è—Å–Ω–µ–Ω–∏–µ', body: '–ï—Ç–æ –∑–∞—â–æ –≤–µ—Ä–Ω–∏—è—Ç –µ‚Ä¶ (—Å–∞–º–æ –Ω–∞ –µ–∫—Ä–∞–Ω–∞)', visibility: 'host' },
        { title: 'Short: –ö–ª—é—á–æ–≤–∞ –¥—É–º–∞', body: '–ù–∞–ø–∏—à–∏ –∫–ª—é—á–æ–≤–∞ –¥—É–º–∞ –∑–∞ –µ–ø–æ—Ö–∞—Ç–∞.', visibility: 'students',
          interaction: { kind: 'short', correctText: '–≤—ä–∑—Ä–∞–∂–¥–∞–Ω–µ', caseSensitive: false, points: 1 }
        },
        { title: '–§–∏–Ω–∞–ª', body: '–ë—Ä–∞–≤–æ! (—Å–∞–º–æ –Ω–∞ –µ–∫—Ä–∞–Ω–∞)', visibility: 'host' },
      ]
    };

    // === STATE ===
    let currentUser = null;
    let mode = 'welcome'; // welcome | host | student

    // Host state
    let hostPin = null;
    let hostLessonId = null;
    let hostLesson = null; // {title, slides}
    let hostActiveSlideIdx = -1;
    let hostPhase = 'waiting';

    // Student state
    let studentPin = null;
    let studentLessonId = null;
    let studentLesson = null;
    let studentActiveSlideIdx = -1;
    let studentPhase = 'waiting';

    // Cache helpers
    const lessonCacheKey = (lessonId) => `lm_lesson_cache_${lessonId}`;
    function cacheLesson(lessonId, lessonObj) {
      try { localStorage.setItem(lessonCacheKey(lessonId), JSON.stringify(lessonObj)); } catch(e) {}
    }
    function getCachedLesson(lessonId) {
      try {
        const raw = localStorage.getItem(lessonCacheKey(lessonId));
        return raw ? JSON.parse(raw) : null;
      } catch(e) { return null; }
    }

    let unsub = { session: null, participants: null, answers: null, answerMine: null };

    // === UI HELPERS ===
    const $ = (id) => document.getElementById(id);
    const show = (id) => $(id).classList.remove('hidden');
    const hide = (id) => $(id).classList.add('hidden');
    const setPill = (id, text) => $(id).textContent = text;

    function setMode(nextMode) {
      mode = nextMode;
      hide('screen-welcome'); hide('screen-host'); hide('screen-student');
      if (nextMode === 'welcome') show('screen-welcome');
      if (nextMode === 'host') show('screen-host');
      if (nextMode === 'student') show('screen-student');
      setPill('mode-pill', `MODE: ${nextMode.toUpperCase()}`);
    }

    function setStatus(text) {
      setPill('status-pill', `STATUS: ${text}`);
    }

    function safeLower(s) { return (s ?? '').toString().trim().toLowerCase(); }

    function isInteractiveSlide(slide) {
      return !!(slide && slide.visibility !== 'host' && slide.interaction && (slide.interaction.kind === 'mcq' || slide.interaction.kind === 'short'));
    }

    // === AUTH ===
    onAuthStateChanged(auth, (u) => {
      currentUser = u;
      if (u) setStatus(`signed-in (${u.isAnonymous ? 'anon' : 'user'})`);
      else setStatus('signed-out');
    });

    async function ensureAnonAuth() {
      if (!auth.currentUser) await signInAnonymously(auth);
    }

    // === HOST FLOW ===
    function genPin() { return String(Math.floor(1000 + Math.random() * 9000)); }
    function genLessonId() { return 'demo-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2, 8); }

    async function hostLogin() {
      const pw = $('teacher-pass').value;
      if (pw !== TEACHER_PASSWORD) {
        alert('–ì—Ä–µ—à–Ω–∞ –ø–∞—Ä–æ–ª–∞ (—Ç–µ—Å—Ç).');
        return;
      }
      await ensureAnonAuth();

      // Demo lesson from localStorage or built-in
      const localDemo = JSON.parse(localStorage.getItem('lm_demo_lesson') || 'null');
      hostLesson = localDemo || demoLesson;

      // Upload lesson (once)
      hostLessonId = genLessonId();
      await setDoc(lessonsDocRef(hostLessonId), {
        lessonId: hostLessonId,
        title: hostLesson.title,
        slides: hostLesson.slides,
        createdAt: serverTimestamp()
      });

      // Create session referencing lessonId
      hostPin = genPin();
      await setDoc(sessionDocRef(hostPin), {
        pin: hostPin,
        title: hostLesson.title,
        lessonId: hostLessonId,
        activeSlideIdx: -1,
        phase: 'waiting',
        createdAt: serverTimestamp()
      });

      $('host-pin').textContent = hostPin;
      $('host-lesson-id').textContent = hostLessonId;
      const joinLink = `${window.location.origin}${window.location.pathname}?pin=${hostPin}`;
      $('host-join-link').textContent = joinLink;

      setMode('host');
      attachHostListeners(hostPin);
      renderHostSlide(null);
    }

    async function hostStart() {
      if (!hostPin) return;
      hostActiveSlideIdx = 0;
      const slide = hostLesson?.slides?.[hostActiveSlideIdx] ?? null;
      hostPhase = isInteractiveSlide(slide) ? 'answering' : 'active';

      await updateDoc(sessionDocRef(hostPin), {
        activeSlideIdx: hostActiveSlideIdx,
        phase: hostPhase
      });
    }

    async function hostNext() {
      if (!hostPin) return;
      const nextIdx = hostActiveSlideIdx + 1;
      if (!hostLesson || nextIdx >= hostLesson.slides.length) {
        await updateDoc(sessionDocRef(hostPin), { phase: 'done' });
        alert('–ö—Ä–∞–π –Ω–∞ —É—Ä–æ–∫–∞.');
        return;
      }
      hostActiveSlideIdx = nextIdx;
      const slide = hostLesson?.slides?.[hostActiveSlideIdx] ?? null;
      hostPhase = isInteractiveSlide(slide) ? 'answering' : 'active';

      await updateDoc(sessionDocRef(hostPin), {
        activeSlideIdx: hostActiveSlideIdx,
        phase: hostPhase
      });
    }

    async function hostLock() {
      if (!hostPin) return;
      await updateDoc(sessionDocRef(hostPin), { phase: 'locked' });
    }

    async function hostReveal() {
      if (!hostPin) return;
      await updateDoc(sessionDocRef(hostPin), { phase: 'reveal' });
    }

    async function hostEnd() {
      if (!hostPin) return;
      await updateDoc(sessionDocRef(hostPin), { phase: 'done' });
      cleanupSubs();
      hostPin = null;
      hostLessonId = null;
      hostLesson = null;
      setMode('welcome');
    }

    function cleanupSubs() {
      Object.values(unsub).forEach(fn => { try { fn && fn(); } catch(e) {} });
      unsub = { session: null, participants: null, answers: null, answerMine: null };
    }

    async function ensureHostLessonLoaded(lessonId) {
      if (hostLesson && hostLessonId === lessonId) return;
      const cached = getCachedLesson(lessonId);
      if (cached) { hostLesson = cached; hostLessonId = lessonId; return; }

      const lSnap = await getDoc(lessonsDocRef(lessonId));
      const data = lSnap.data();
      if (data) {
        hostLesson = { title: data.title, slides: data.slides };
        hostLessonId = lessonId;
        cacheLesson(lessonId, hostLesson);
      }
    }

    function attachHostListeners(pin) {
      cleanupSubs();

      unsub.session = onSnapshot(sessionDocRef(pin), async (snap) => {
        const d = snap.data();
        if (!d) return;

        hostLessonId = d.lessonId || hostLessonId;
        hostActiveSlideIdx = d.activeSlideIdx ?? -1;
        hostPhase = d.phase || 'waiting';

        $('host-lesson-id').textContent = hostLessonId || '‚Äî';

        if (hostLessonId) await ensureHostLessonLoaded(hostLessonId);

        const slide = (hostLesson?.slides && hostActiveSlideIdx >= 0) ? hostLesson.slides[hostActiveSlideIdx] : null;

        $('host-slide-counter').textContent = hostLesson ? `${Math.max(hostActiveSlideIdx,0)+1} / ${hostLesson.slides.length}` : '‚Äî';
        renderHostSlide(slide);

        // answers listener for current slide only (if interactive)
        if (unsub.answers) { unsub.answers(); unsub.answers = null; }
        if (slide && hostActiveSlideIdx >= 0 && isInteractiveSlide(slide)) {
          unsub.answers = onSnapshot(answersColRef(pin, hostActiveSlideIdx), (qsnap) => {
            const answers = qsnap.docs.map(x => ({ id: x.id, ...x.data() }));
            $('stat-answered').textContent = String(answers.length);
            renderStatsForSlide(slide, answers);
          });
        } else {
          $('stat-answered').textContent = '0';
          $('stat-mcq').innerHTML = `<div class="muted font-bold">‚Äî</div>`;
          $('stat-short').innerHTML = `<div class="muted font-bold">‚Äî</div>`;
        }
      });

      unsub.participants = onSnapshot(participantsColRef(pin), (snap) => {
        $('stat-participants').textContent = String(snap.size);
      });
    }

    function renderHostSlide(slide) {
      if (!slide) {
        $('host-slide-title').textContent = '‚Äî';
        $('host-slide-meta').textContent = '‚Äî';
        $('host-slide-body').textContent = '–°—Ç–∞—Ä—Ç–∏—Ä–∞–π —Å–µ—Å–∏—è –∏ –Ω–∞—Ç–∏—Å–Ω–∏ Start.';
        return;
      }
      $('host-slide-title').textContent = slide.title || '(–±–µ–∑ –∑–∞–≥–ª–∞–≤–∏–µ)';
      $('host-slide-meta').textContent = `visibility: ${slide.visibility || 'host'} ‚Ä¢ phase: ${hostPhase}`;
      $('host-slide-body').textContent = slide.body || '';
    }

    function renderStatsForSlide(slide, answers) {
      const kind = slide.interaction.kind;

      if (kind === 'mcq') {
        const opts = slide.interaction.options || [];
        const counts = Array(opts.length).fill(0);
        for (const a of answers) {
          const idx = Number(a.answerIndex);
          if (!Number.isNaN(idx) && idx >= 0 && idx < counts.length) counts[idx]++;
        }
        $('stat-mcq').innerHTML = opts.map((t, i) => {
          const isCorrect = (i === slide.interaction.correct);
          return `
            <div class="flex items-center justify-between">
              <div class="font-black ${isCorrect ? 'text-emerald-700' : 'text-slate-700'}">${i+1}. ${escapeHtml(t)}${isCorrect ? ' ‚úÖ' : ''}</div>
              <div class="font-black">${counts[i] || 0}</div>
            </div>
          `;
        }).join('');
        $('stat-short').innerHTML = `<div class="muted font-bold">‚Äî</div>`;
      }

      if (kind === 'short') {
        $('stat-mcq').innerHTML = `<div class="muted font-bold">‚Äî</div>`;
        const preview = answers.slice(0, 10).map(a => {
          const txt = (a.answerText ?? '').toString();
          return `<div class="p-2 rounded-xl bg-slate-50 border border-slate-200">
            <div class="text-xs font-black uppercase tracking-widest muted">${escapeHtml(a.name || a.id)}</div>
            <div class="font-black">${escapeHtml(txt) || '‚Äî'}</div>
          </div>`;
        }).join('');
        $('stat-short').innerHTML = preview || `<div class="muted font-bold">–ù—è–º–∞ –æ—Ç–≥–æ–≤–æ—Ä–∏ –æ—â–µ.</div>`;
      }
    }

    // === STUDENT FLOW ===
    async function ensureStudentLessonLoaded(lessonId) {
      if (studentLesson && studentLessonId === lessonId) return;
      const cached = getCachedLesson(lessonId);
      if (cached) { studentLesson = cached; studentLessonId = lessonId; return; }

      const lSnap = await getDoc(lessonsDocRef(lessonId));
      const data = lSnap.data();
      if (data) {
        studentLesson = { title: data.title, slides: data.slides };
        studentLessonId = lessonId;
        cacheLesson(lessonId, studentLesson);
      }
    }

    async function studentJoin(pin) {
      await ensureAnonAuth();

      const name = $('student-name').value.trim() || '–£—á–µ–Ω–∏–∫';
      studentPin = pin;
      $('student-pin-active').textContent = pin;

      await setDoc(participantDocRef(pin, auth.currentUser.uid), {
        name,
        joinedAt: serverTimestamp(),
        score: 0
      }, { merge: true });

      setMode('student');
      attachStudentListeners(pin);
      showStudentWaiting('–ì–ª–µ–¥–∞–π –µ–∫—Ä–∞–Ω–∞ –æ—Ç–ø—Ä–µ–¥‚Ä¶');
    }

    function attachStudentListeners(pin) {
      cleanupSubs();

      unsub.session = onSnapshot(sessionDocRef(pin), async (snap) => {
        const d = snap.data();
        if (!d) { showStudentWaiting('–°–µ—Å–∏—è—Ç–∞ –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–∞.'); return; }

        studentLessonId = d.lessonId || studentLessonId;
        studentActiveSlideIdx = d.activeSlideIdx ?? -1;
        studentPhase = d.phase || 'waiting';

        if (studentPhase === 'done') {
          showStudentWaiting('–°–µ—Å–∏—è—Ç–∞ –ø—Ä–∏–∫–ª—é—á–∏. –ë–ª–∞–≥–æ–¥–∞—Ä—è!');
          return;
        }

        if (!studentLessonId) {
          showStudentWaiting('–ó–∞—Ä–µ–∂–¥–∞–º —É—Ä–æ–∫‚Ä¶');
          return;
        }

        await ensureStudentLessonLoaded(studentLessonId);

        const slide = (studentLesson?.slides && studentActiveSlideIdx >= 0) ? studentLesson.slides[studentActiveSlideIdx] : null;

        // Only interactive slides on phones
        if (!slide || !isInteractiveSlide(slide)) {
          const msg = studentPhase === 'waiting'
            ? '–û—á–∞–∫–≤–∞–º–µ —Å—Ç–∞—Ä—Ç‚Ä¶'
            : '–ì–ª–µ–¥–∞–π –µ–∫—Ä–∞–Ω–∞ –æ—Ç–ø—Ä–µ–¥‚Ä¶';
          showStudentWaiting(msg);
          // stop any "my answer" listener
          if (unsub.answerMine) { unsub.answerMine(); unsub.answerMine = null; }
          return;
        }

        showStudentInteraction(slide, studentPhase, studentActiveSlideIdx);

        // Listen to MY answer for this slide to prevent double-submit & show sent status
        if (unsub.answerMine) { unsub.answerMine(); unsub.answerMine = null; }
        unsub.answerMine = onSnapshot(answerDocRef(pin, studentActiveSlideIdx, auth.currentUser.uid), (aSnap) => {
          const exists = aSnap.exists();
          updateStudentSubmitState({ hasAnswer: exists, phase: studentPhase });
          if (exists) $('student-sent').classList.remove('hidden');
        });
      });
    }

    function showStudentWaiting(msg) {
      show('student-waiting');
      hide('student-interaction');
      $('student-waiting-msg').textContent = msg;
    }

    function updateStudentSubmitState({ hasAnswer, phase }) {
      const locked = (phase === 'locked' || phase === 'reveal');
      const btn = $('btn-student-submit');

      if (hasAnswer) {
        btn.textContent = '–ò–ó–ü–†–ê–¢–ï–ù–û ‚úÖ';
        btn.classList.add('disabled');
        return;
      }

      btn.textContent = locked ? '–ó–ê–ö–õ–Æ–ß–ï–ù–û üîí' : '–ü–æ—Ç–≤—ä—Ä–¥–∏';
      btn.classList.toggle('disabled', locked);
    }

    function showStudentInteraction(slide, phase, slideIdx) {
      hide('student-waiting');
      show('student-interaction');

      $('student-q-title').textContent = slide.title || '–í—ä–ø—Ä–æ—Å';
      $('student-q-sub').textContent = slide.body || '';
      $('student-phase').textContent = phase.toUpperCase();

      $('student-sent').classList.add('hidden');
      const body = $('student-q-body');
      body.innerHTML = '';

      const locked = (phase === 'locked' || phase === 'reveal');

      // Default state (may be overridden by "hasAnswer" snapshot)
      updateStudentSubmitState({ hasAnswer: false, phase });

      if (slide.interaction.kind === 'mcq') {
        const opts = slide.interaction.options || [];
        body.innerHTML = `
          <div class="space-y-3" id="mcq-list">
            ${opts.map((t, i) => `<button class="opt w-full text-left" data-idx="${i}">${i+1}. ${escapeHtml(t)}</button>`).join('')}
          </div>
        `;
        let selected = null;

        body.querySelectorAll('.opt').forEach(btn => {
          btn.addEventListener('click', () => {
            if (locked) return;
            body.querySelectorAll('.opt').forEach(x => x.classList.remove('selected'));
            btn.classList.add('selected');
            selected = Number(btn.dataset.idx);
          });
        });

        $('btn-student-submit').onclick = () => submitStudentAnswer(slide, slideIdx, { answerIndex: selected });

      } else if (slide.interaction.kind === 'short') {
        body.innerHTML = `
          <div class="space-y-2">
            <label class="text-xs font-black uppercase tracking-widest muted">–¢–≤–æ—è—Ç –æ—Ç–≥–æ–≤–æ—Ä</label>
            <input id="short-input" class="w-full p-4 rounded-2xl border-2 border-slate-200 font-black outline-none focus:border-sky-600" placeholder="–ù–∞–ø–∏—à–∏..." />
          </div>
        `;
        $('btn-student-submit').onclick = () => {
          const txt = $('short-input').value ?? '';
          submitStudentAnswer(slide, slideIdx, { answerText: txt });
        };
      }
    }

    async function submitStudentAnswer(slide, slideIdx, payload) {
      const pin = studentPin;
      if (!pin || !auth.currentUser) return;

      // Validate
      if (slide.interaction.kind === 'mcq') {
        if (payload.answerIndex === null || payload.answerIndex === undefined || Number.isNaN(Number(payload.answerIndex))) {
          alert('–ò–∑–±–µ—Ä–∏ –æ—Ç–≥–æ–≤–æ—Ä.');
          return;
        }
      }
      if (slide.interaction.kind === 'short') {
        const t = (payload.answerText ?? '').toString().trim();
        if (!t) { alert('–ù–∞–ø–∏—à–∏ –æ—Ç–≥–æ–≤–æ—Ä.'); return; }
      }

      const sSnap = await getDoc(sessionDocRef(pin));
      const sData = sSnap.data();
      const phase = sData?.phase || 'waiting';
      const activeIdx = sData?.activeSlideIdx;

      // Guard against stale submits
      if (phase === 'locked' || phase === 'reveal') {
        alert('–ó–∞–∫–ª—é—á–µ–Ω–æ.');
        return;
      }
      if (activeIdx !== slideIdx) {
        alert('–°–ª–∞–π–¥—ä—Ç –≤–µ—á–µ –µ —Å–º–µ–Ω–µ–Ω.');
        return;
      }

      const name = ($('student-name').value.trim() || '–£—á–µ–Ω–∏–∫');

      await setDoc(answerDocRef(pin, slideIdx, auth.currentUser.uid), {
        uid: auth.currentUser.uid,
        name,
        kind: slide.interaction.kind,
        ...payload,
        answeredAt: serverTimestamp()
      }, { merge: true });

      $('student-sent').classList.remove('hidden');
      updateStudentSubmitState({ hasAnswer: true, phase });
    }

    // === UTIL ===
    function escapeHtml(s) {
      return (s ?? '').toString()
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // === WIRE UI ===
    $('btn-load-demo').addEventListener('click', () => {
      localStorage.setItem('lm_demo_lesson', JSON.stringify(demoLesson));
      alert('Demo —É—Ä–æ–∫—ä—Ç –µ –∑–∞—Ä–µ–¥–µ–Ω –ª–æ–∫–∞–ª–Ω–æ (localStorage). –ù–∞—Ç–∏—Å–Ω–∏ –í—Ö–æ–¥.');
    });

    $('btn-host-login').addEventListener('click', hostLogin);
    $('btn-host-start').addEventListener('click', hostStart);
    $('btn-host-next').addEventListener('click', hostNext);
    $('btn-host-lock').addEventListener('click', hostLock);
    $('btn-host-reveal').addEventListener('click', hostReveal);
    $('btn-host-end').addEventListener('click', hostEnd);

    $('btn-student-join').addEventListener('click', async () => {
      const pin = $('student-pin').value.trim();
      if (!pin) return alert('–í—ä–≤–µ–¥–∏ PIN.');
      await studentJoin(pin);
    });

    $('btn-student-leave').addEventListener('click', async () => {
      cleanupSubs();
      try { await signOut(auth); } catch(e) {}
      studentPin = null;
      studentLessonId = null;
      studentLesson = null;
      setMode('welcome');
    });

    window.addEventListener('DOMContentLoaded', () => {
      setMode('welcome');
      setStatus('ready');
      const p = new URLSearchParams(window.location.search).get('pin');
      if (p) $('student-pin').value = p;
    });
  </script>
</body>
</html>
