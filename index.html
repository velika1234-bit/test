<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LessonMaster Pro</title>
    
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Roboto+Slab:wght@700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = { 
            theme: { 
                extend: { 
                    fontFamily: { sans: ['Nunito', 'sans-serif'], display: ['Pacifico', 'cursive'], slab: ['Roboto Slab', 'serif'] }, 
                    colors: { brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 900: '#0c4a6e' } } 
                } 
            } 
        }
    </script>

    <style>
        body { font-family: 'Nunito', sans-serif; -webkit-font-smoothing: antialiased; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        @keyframes pop { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        .slide-preview { transition: all 0.2s; border-left: 4px solid transparent; }
        .slide-preview.active { border-left-color: #0284c7; background-color: #f0f9ff; }
        
        /* Labeling Styles */
        .label-target {
            position: absolute; width: 32px; height: 32px; background: rgba(255, 255, 255, 0.9);
            border: 3px solid #0284c7; border-radius: 50%; transform: translate(-50%, -50%);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: #0284c7; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 10; font-size: 14px;
        }
        .label-target.filled { background: #0284c7; color: white; border-color: white; width: auto; padding: 4px 12px; border-radius: 12px; }
        .label-chip {
            padding: 10px 20px; background: white; border: 2px solid #e2e8f0; border-radius: 99px;
            font-weight: bold; cursor: pointer; user-select: none; transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .label-chip.selected { background: #0284c7; color: white; border-color: #0284c7; transform: scale(1.05); }
        .label-chip.placed { opacity: 0.5; pointer-events: none; background: #f1f5f9; border-color: #cbd5e1; }

        input[type=range] { accent-color: #0284c7; }
        .sop-text { font-size: 1.5rem !important; line-height: 1.4 !important; }
        .slide-bg-cover { background-size: cover; background-position: center; }
        .compact-control { height: 2rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; font-size: 0.75rem; font-weight: bold; padding: 0 0.5rem; cursor: pointer; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden selection:bg-brand-200">

    <div id="app" class="h-full flex flex-col relative">
        <!-- Loader -->
        <div id="auth-loader" class="fixed inset-0 bg-white z-[10000] flex items-center justify-center flex-col gap-6">
            <div class="w-16 h-16 border-8 border-brand-100 border-t-brand-600 rounded-full animate-spin"></div>
            <p class="font-black text-brand-900 tracking-[0.3em] uppercase text-xs">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</p>
        </div>
        <div id="msg-container" class="fixed top-6 right-6 z-[10001] flex flex-col items-end pointer-events-none gap-2"></div>

        <!-- 1. –í–•–û–î -->
        <div id="screen-welcome" class="flex h-full w-full bg-white relative z-10 overflow-hidden flex-col md:flex-row">
            <!-- Student -->
            <div class="flex-1 flex flex-col justify-center items-center p-6 bg-slate-50 relative">
                <div class="w-full max-w-md space-y-8 animate-pop text-center z-10">
                    <div>
                        <h1 class="text-6xl font-black text-brand-900 tracking-tighter mb-2 drop-shadow-sm font-display">LessonMaster</h1>
                        <p class="text-slate-500 font-bold uppercase tracking-widest text-xs">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏ –£—Ä–æ—Ü–∏</p>
                    </div>
                    
                    <!-- Tabs -->
                    <div class="bg-white p-1.5 rounded-2xl shadow-sm border border-slate-200 flex">
                        <button onclick="window.switchTab('solo')" id="tab-solo" class="flex-1 py-3 rounded-xl font-black text-sm bg-brand-600 text-white shadow-md transition-all">–°–ê–ú–û–°–¢–û–Ø–¢–ï–õ–ù–û</button>
                        <button onclick="window.switchTab('class')" id="tab-class" class="flex-1 py-3 rounded-xl font-black text-sm text-slate-400 hover:bg-slate-50 transition-all">–í –ö–õ–ê–°</button>
                    </div>

                    <!-- Solo -->
                    <div id="panel-solo" class="bg-white p-8 rounded-[2.5rem] border border-slate-200 shadow-xl space-y-5">
                        <input type="text" id="ind-student-name" placeholder="–¢–≤–æ–µ—Ç–æ –ò–º–µ" class="input-field text-center">
                        <input type="text" id="ind-quiz-code" placeholder="–ü–æ—Å—Ç–∞–≤–∏ –¥—ä–ª–≥–∏—è –∫–æ–¥ —Ç—É–∫..." class="input-field text-center font-mono text-xs tracking-wider">
                        <div class="grid grid-cols-2 gap-3">
                            <label class="option-label"><input type="checkbox" id="ind-sop-mode" class="accent-brand-600 w-5 h-5"> <span class="text-brand-600">–°–û–ü üîä</span></label>
                            <label class="option-label"><input type="checkbox" id="ind-discussion-mode" class="accent-amber-500 w-5 h-5"> <span class="text-amber-600">–û–ë–°–™–ñ–î–ê–ù–ï</span></label>
                        </div>
                        <button onclick="window.startIndividual()" class="btn-primary w-full py-5 text-xl bg-brand-600 hover:bg-brand-700 shadow-brand-200">–°–¢–ê–†–¢</button>
                    </div>

                    <!-- Class -->
                    <div id="panel-class" class="hidden bg-white p-8 rounded-[2.5rem] border-t-8 border-emerald-500 shadow-xl space-y-5">
                        <input type="text" id="live-student-name" placeholder="–¢–≤–æ–µ—Ç–æ –ò–º–µ" class="input-field border-emerald-100 focus:border-emerald-500 text-center">
                        <input type="number" id="live-pin" placeholder="PIN" class="input-field text-center font-black text-2xl tracking-[0.2em] border-emerald-100 focus:border-emerald-500 placeholder-emerald-100/50">
                        <button onclick="window.joinLiveSession()" class="btn-primary w-full py-5 text-xl bg-emerald-500 hover:bg-emerald-600 shadow-emerald-200">–í–õ–ï–ó –í –ß–ê–°</button>
                    </div>
                </div>
            </div>

            <!-- Teacher Login -->
            <div class="hidden md:flex w-full md:w-[450px] bg-slate-900 text-white p-12 flex-col justify-center relative shadow-2xl z-20">
                <div class="relative z-10 space-y-12 animate-pop text-center">
                    <div>
                        <div class="w-20 h-20 bg-brand-600 rounded-3xl flex items-center justify-center text-4xl mb-6 mx-auto shadow-2xl rotate-3"><i data-lucide="presentation"></i></div>
                        <h2 class="text-4xl font-black mb-2 tracking-tight">–£—á–∏—Ç–µ–ª—Å–∫–∏ –ü–∞–Ω–µ–ª</h2>
                        <p class="text-slate-400 text-sm font-medium">–°—ä–∑–¥–∞–≤–∞–Ω–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —É—Ä–æ—Ü–∏.</p>
                    </div>
                    
                    <div class="space-y-4">
                        <input type="password" id="teacher-password" placeholder="–ü–∞—Ä–æ–ª–∞ –∑–∞ –¥–æ—Å—Ç—ä–ø" class="w-full p-5 bg-white/10 border border-white/10 rounded-2xl text-white text-center font-bold outline-none focus:border-brand-500 transition-all text-xl">
                        <button id="login-btn" onclick="window.directTeacherLogin()" class="w-full py-5 bg-brand-600 hover:bg-brand-500 text-white rounded-[2rem] font-black text-xl shadow-2xl transition-all border-b-8 border-brand-800 active:border-b-0 active:translate-y-2 uppercase tracking-widest flex items-center justify-center gap-3">
                            –í–õ–ï–ó <i data-lucide="arrow-right" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
            </div>
            <button onclick="document.querySelector('.md\\:flex').classList.remove('hidden');document.querySelector('.md\\:flex').classList.add('flex');" class="md:hidden absolute top-4 right-4 bg-slate-900 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-lg z-50">–£—á–∏—Ç–µ–ª</button>
        </div>

        <!-- 2. –ë–ò–ë–õ–ò–û–¢–ï–ö–ê -->
        <div id="screen-dashboard" class="hidden h-full flex flex-col bg-slate-50 absolute inset-0 z-20">
            <header class="bg-white border-b px-8 py-5 flex justify-between items-center shrink-0 shadow-sm z-10">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-brand-600 rounded-2xl flex items-center justify-center text-white text-2xl shadow-lg rotate-3"><i data-lucide="library"></i></div>
                    <h1 class="text-2xl font-black text-slate-800 tracking-tight">–ë–ò–ë–õ–ò–û–¢–ï–ö–ê</h1>
                </div>
                <div class="flex gap-3">
                    <input type="file" id="import-file" class="hidden" accept=".json" onchange="window.importLessonFromFile(this)">
                    <button onclick="document.getElementById('import-file').click()" class="btn-secondary px-6 py-3 text-xs flex items-center gap-2"><i data-lucide="upload" class="w-4 h-4"></i> –ó–ê–†–ï–î–ò –§–ê–ô–õ</button>
                    <button onclick="window.initCreateMode()" class="btn-primary px-6 py-3 text-xs flex items-center gap-2 bg-brand-600 hover:bg-brand-700 shadow-xl transform hover:-translate-y-1"><i data-lucide="plus" class="w-4 h-4"></i> –ù–û–í –£–†–û–ö</button>
                    <button onclick="window.handleLogout()" class="p-3 bg-slate-200 text-slate-500 hover:bg-rose-100 hover:text-rose-500 rounded-xl transition-all"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                </div>
            </header>
            <main class="flex-1 overflow-y-auto p-8 max-w-7xl mx-auto w-full space-y-10 pb-32">
                <div id="my-quizzes-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </main>
        </div>

        <!-- 3. –†–ï–î–ê–ö–¢–û–† -->
        <div id="screen-editor" class="hidden h-full flex flex-col bg-slate-100 absolute inset-0 z-30">
            <header class="bg-white border-b px-6 py-4 flex items-center justify-between shrink-0 shadow-sm z-20">
                <div class="flex items-center gap-4">
                    <button onclick="window.switchScreen('dashboard')" class="p-3 bg-slate-100 hover:bg-slate-200 rounded-2xl transition-all"><i data-lucide="arrow-left" class="w-5 h-5 text-slate-600"></i></button>
                    <input type="text" id="lesson-title" placeholder="–ó–∞–≥–ª–∞–≤–∏–µ –Ω–∞ —É—Ä–æ–∫–∞..." class="text-xl font-black text-slate-800 bg-transparent border-b-2 border-transparent focus:border-brand-500 outline-none w-96 transition-all">
                </div>
                <div class="flex gap-2">
                    <button onclick="window.downloadLesson()" class="px-6 py-3 bg-slate-800 text-white rounded-2xl font-bold text-xs hover:bg-black shadow-lg flex items-center gap-2"><i data-lucide="download" class="w-4 h-4"></i> –ò–ó–¢–ï–ì–õ–ò (–§–ê–ô–õ)</button>
                    <button onclick="window.saveLessonToCloud()" class="px-6 py-3 bg-brand-600 text-white rounded-2xl font-bold text-xs hover:bg-brand-700 shadow-xl shadow-brand-200 flex items-center gap-2"><i data-lucide="cloud" class="w-4 h-4"></i> –ó–ê–ü–ê–ó–ò</button>
                </div>
            </header>
            
            <div class="flex-1 flex overflow-hidden">
                <!-- Sidebar Slides -->
                <div class="w-64 bg-white border-r border-slate-200 flex flex-col shrink-0 z-10">
                    <div class="p-4 border-b border-slate-100 bg-slate-50 font-black text-xs text-slate-400 uppercase tracking-widest text-center">–°–ª–∞–π–¥–æ–≤–µ</div>
                    <div id="slides-list" class="flex-1 overflow-y-auto p-2 space-y-2"></div>
                    <div class="p-4 border-t border-slate-100 grid grid-cols-4 gap-1 bg-slate-50">
                        <button onclick="window.addSlide('title')" class="flex flex-col items-center justify-center p-2 bg-white border-2 border-slate-200 rounded-xl hover:border-brand-500 hover:text-brand-600 transition-all text-[8px] font-bold uppercase"><i data-lucide="heading" class="w-4 h-4 mb-1"></i> –ó–∞–≥–ª.</button>
                        <button onclick="window.addSlide('content')" class="flex flex-col items-center justify-center p-2 bg-white border-2 border-slate-200 rounded-xl hover:border-brand-500 hover:text-brand-600 transition-all text-[8px] font-bold uppercase"><i data-lucide="image" class="w-4 h-4 mb-1"></i> –ö–æ–Ω—Ç.</button>
                        <button onclick="window.addSlide('question')" class="flex flex-col items-center justify-center p-2 bg-white border-2 border-slate-200 rounded-xl hover:border-brand-500 hover:text-brand-600 transition-all text-[8px] font-bold uppercase"><i data-lucide="help-circle" class="w-4 h-4 mb-1"></i> –í—ä–ø—Ä.</button>
                        <button onclick="window.addSlide('labeling')" class="flex flex-col items-center justify-center p-2 bg-white border-2 border-slate-200 rounded-xl hover:border-brand-500 hover:text-brand-600 transition-all text-[8px] font-bold uppercase"><i data-lucide="tag" class="w-4 h-4 mb-1"></i> –ï—Ç–∏–∫.</button>
                    </div>
                </div>

                <!-- Main Editor Area -->
                <div class="flex-1 bg-slate-50 p-8 overflow-y-auto flex flex-col items-center">
                    <div id="slide-editor-container" class="w-full max-w-4xl bg-white rounded-[2rem] shadow-xl p-10 min-h-[600px] border border-slate-200 relative">
                        <p class="text-center text-slate-400 font-bold mt-20">–ò–∑–±–µ—Ä–µ—Ç–µ –∏–ª–∏ –¥–æ–±–∞–≤–µ—Ç–µ —Å–ª–∞–π–¥ –æ—Ç –º–µ–Ω—é—Ç–æ –≤–ª—è–≤–æ.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. –ù–ê –ñ–ò–í–û (HOST) -->
        <div id="screen-live-host" class="hidden h-full flex flex-col bg-slate-900 absolute inset-0 z-[60]">
            <div class="h-24 bg-slate-800 border-b border-white/10 px-8 flex justify-between items-center shrink-0 shadow-xl z-20">
                <div class="flex items-center gap-6">
                    <div class="bg-brand-600 px-6 py-2 rounded-2xl text-center shadow-lg border border-brand-400/30">
                        <span class="text-[9px] font-black text-brand-200 block uppercase tracking-widest">PIN</span>
                        <span id="host-pin-display" class="text-3xl font-black text-white leading-none tracking-tight">....</span>
                    </div>
                    <div class="text-white">
                        <div id="host-count" class="text-3xl font-black tracking-tighter leading-none">0</div>
                        <div class="text-[10px] font-black text-slate-500 uppercase tracking-widest">–£—á–µ–Ω–∏—Ü–∏</div>
                    </div>
                </div>
                <button onclick="window.finishSession()" class="bg-emerald-600 text-white px-8 py-3 rounded-xl font-black text-xs hover:bg-emerald-500 uppercase tracking-widest border-b-4 border-emerald-800 active:border-b-0 active:translate-y-1 transition-all">–ö–†–ê–ô</button>
            </div>
            
            <div class="flex-1 flex flex-col items-center justify-center p-8 text-center relative overflow-hidden bg-slate-950">
                 <!-- Slide Content Area (Big Screen) -->
                 <div id="host-slide-display" class="w-full max-w-6xl h-full flex flex-col items-center justify-center">
                      <div id="host-waiting-screen" class="animate-pop">
                          <div id="host-qr-container" class="bg-white p-4 rounded-3xl mb-8 w-64 h-64 shadow-2xl mx-auto"></div>
                          <h2 class="text-5xl font-black text-white mb-8 tracking-tighter uppercase">–û—á–∞–∫–≤–∞–º–µ –∏–≥—Ä–∞—á–∏...</h2>
                          <button onclick="window.startLiveLesson()" class="px-16 py-6 bg-brand-600 text-white rounded-full font-black text-4xl shadow-xl hover:bg-brand-500 transition-all flex items-center gap-4 mx-auto uppercase tracking-tight"><i data-lucide="play" class="w-10 h-10 fill-current"></i> –°–¢–ê–†–¢</button>
                      </div>
                      
                      <!-- Dynamic Slide Content -->
                      <div id="host-active-slide" class="hidden w-full h-full flex flex-col relative bg-white rounded-[3rem] overflow-hidden p-0 text-slate-900 shadow-2xl">
                           <div id="host-slide-content" class="flex-1 flex flex-col items-center justify-center text-center w-full h-full relative p-12 slide-bg-cover"></div>
                           <div class="absolute bottom-6 right-6 flex items-center gap-4 z-20">
                               <div class="text-2xl font-black text-slate-300 drop-shadow-md" id="host-slide-num">1 / 1</div>
                               <button onclick="window.nextLiveSlide()" class="w-16 h-16 bg-slate-900 text-white rounded-full flex items-center justify-center shadow-xl hover:bg-black transition-all"><i data-lucide="arrow-right" class="w-8 h-8"></i></button>
                           </div>
                      </div>
                 </div>
            </div>
        </div>

        <!-- 5. –£–ß–ï–ù–ò–ö (CLIENT) -->
        <div id="screen-live-client" class="hidden h-full flex flex-col bg-brand-600 absolute inset-0 z-[70] overflow-hidden">
             <!-- Waiting -->
             <div id="client-waiting" class="flex-1 flex flex-col items-center justify-center p-8 text-center space-y-8 animate-pop text-white">
                 <div class="text-8xl animate-bounce filter drop-shadow-xl">üéì</div>
                 <h2 class="text-3xl font-black uppercase tracking-tight" id="client-status-msg">–ü—Ä–∏–≥–æ—Ç–≤–∏ —Å–µ...</h2>
             </div>
             
             <!-- Content -->
             <div id="client-active-view" class="hidden flex-1 flex flex-col bg-slate-50 relative slide-bg-cover">
                 <div id="client-slide-overlay" class="absolute inset-0 bg-white/95 z-0"></div>
                 <div class="p-4 bg-white/80 backdrop-blur border-b border-slate-200 shadow-sm text-center z-10 relative">
                     <h2 id="client-slide-title" class="text-xl font-black text-slate-800 leading-tight">...</h2>
                 </div>
                 <div id="client-slide-body" class="flex-1 p-6 overflow-y-auto pb-32 z-10 relative flex flex-col items-center justify-center text-center"></div>
                 <div id="client-confirm-bar" class="hidden fixed bottom-0 left-0 w-full p-4 bg-white border-t border-slate-200 z-[100] shadow-lg">
                     <button id="client-action-btn" onclick="window.submitLiveAnswer()" class="w-full py-4 bg-brand-600 text-white rounded-2xl font-black text-xl shadow-lg active:scale-95 transition-all uppercase tracking-widest">–ü–û–¢–í–™–†–î–ò</button>
                 </div>
             </div>
        </div>

        <!-- Share Modal -->
        <div id="modal-share" class="hidden fixed inset-0 bg-black/90 z-[200] items-center justify-center p-6 backdrop-blur-md">
             <div class="bg-white rounded-[2.5rem] shadow-2xl p-10 max-w-md w-full text-center animate-pop">
                 <h3 class="text-3xl font-black text-slate-900 mb-2 uppercase tracking-tight">–ö–æ–¥ –∑–∞ –î–æ—Å—Ç—ä–ø</h3>
                 <textarea id="share-code-area" class="w-full p-5 bg-slate-50 rounded-2xl font-mono text-xs break-all border-2 border-slate-200 h-32 focus:border-brand-500 outline-none text-slate-600 resize-none mb-8" readonly></textarea>
                 <div class="flex gap-4">
                     <button onclick="window.doCopyCode()" class="flex-1 py-4 bg-brand-600 text-white rounded-2xl font-black text-sm shadow-xl hover:bg-brand-700 transition-all uppercase tracking-widest">–ö–û–ü–ò–†–ê–ô</button>
                     <button onclick="document.getElementById('modal-share').classList.add('hidden')" class="px-8 py-4 bg-slate-100 text-slate-500 rounded-2xl font-black text-sm hover:bg-slate-200 uppercase tracking-widest">–ó–ê–¢–í–û–†–ò</button>
                 </div>
             </div>
        </div>

    </div>

    <!-- === CSS === -->
    <style>
        .input-field { @apply w-full p-4 bg-white rounded-2xl border-2 border-slate-200 font-bold mb-4 outline-none focus:border-brand-500 transition-all text-slate-800 text-lg shadow-sm; }
        .btn-primary { @apply text-white font-black rounded-2xl shadow-xl transition-all active:scale-95 uppercase tracking-widest border-b-4 border-black/20 active:border-b-0 active:translate-y-1; }
        .btn-secondary { @apply bg-white text-slate-600 font-bold rounded-2xl border-2 border-slate-200 hover:border-slate-300 hover:bg-slate-50 transition-all shadow-sm; }
        .option-label { @apply flex-1 flex flex-col items-center justify-center gap-2 p-4 bg-white rounded-2xl border-2 border-slate-200 cursor-pointer text-xs font-black hover:bg-brand-50 transition-colors select-none text-slate-500 uppercase hover:border-brand-200; }
        .slide-item { @apply p-3 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 flex items-center gap-3 transition-all group; }
        .slide-bg-cover { background-size: cover; background-position: center; }
        .compact-control { @apply h-8 border border-slate-200 rounded cursor-pointer text-xs font-bold px-1; }
    </style>

    <!-- === SCRIPT === -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, serverTimestamp, updateDoc, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const appId = 'lessonmaster-pro-v3';
        let firebaseConfig; try { firebaseConfig = JSON.parse(__firebase_config); } catch (e) { firebaseConfig = { apiKey: "AIzaSyA0WhbnxygznaGCcdxLBHweZZThezUO314", authDomain: "videoquiz-ultimate.firebaseapp.com", projectId: "videoquiz-ultimate", storageBucket: "videoquiz-ultimate.firebasestorage.app", messagingSenderId: "793138692820", appId: "1:793138692820:web:8ee2418d28d47fca6bf141" }; }
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let user = null, slides = [], currentLessonId = null;
        let sessionID = "", liveParticipants = [], activeSlideIdx = 0, liveScore = 0;
        let authMode = 'login', sopEnabled = false, isDiscussion = false;
        let tempSelectedLabel = null; 
        let unsubscribes = {};
        
        // PUBLIC COLLECTION
        const PUBLIC_SESSIONS_COLLECTION = 'public_sessions';
        const hexToRgba = (hex, alpha) => { const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16); return `rgba(${r}, ${g}, ${b}, ${alpha})`; };

        // --- HELPERS ---
        window.switchScreen = (n) => { document.querySelectorAll('#app > div').forEach(d => d.classList.add('hidden')); document.getElementById('screen-'+n).classList.remove('hidden'); if(n==='dashboard') window.loadTeacherData(); if(window.lucide) lucide.createIcons(); };
        window.switchTab = (t) => { document.getElementById('panel-solo').classList.toggle('hidden', t!=='solo'); document.getElementById('panel-class').classList.toggle('hidden', t!=='class'); document.getElementById('tab-solo').className = t==='solo'?'flex-1 py-3 rounded-xl font-bold text-sm bg-brand-600 text-white shadow transition-all uppercase tracking-widest':'flex-1 py-3 rounded-xl font-bold text-sm text-slate-500 hover:bg-slate-50 transition-all uppercase tracking-widest'; document.getElementById('tab-class').className = t==='class'?'flex-1 py-3 rounded-xl font-bold text-sm bg-emerald-600 text-white shadow transition-all uppercase tracking-widest':'flex-1 py-3 rounded-xl font-bold text-sm text-slate-500 hover:bg-slate-50 transition-all uppercase tracking-widest'; };

        // --- AUTH ---
        const initAuth = async () => { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { try { await signInWithCustomToken(auth, __initial_auth_token); } catch(e) { } } }; initAuth();
        onAuthStateChanged(auth, u => { user = u; if(u && !window.location.search.includes('pin=')) { if(u.isAnonymous) window.switchScreen('dashboard'); } else if(!window.location.search.includes('pin=')) window.switchScreen('welcome'); const l = document.getElementById('auth-loader'); if(l) { l.style.opacity = '0'; setTimeout(()=>l.classList.add('hidden'),500); } });
        
        window.directTeacherLogin = async () => { 
            const pw = document.getElementById('teacher-password').value;
            if(pw !== 'vilidaf76') return alert("–ì—Ä–µ—à–Ω–∞ –ø–∞—Ä–æ–ª–∞!");
            
            const btn = document.getElementById('login-btn');
            btn.innerText = "–í–ª–∏–∑–∞–Ω–µ...";
            
            try { 
                await signInAnonymously(auth); 
                window.switchScreen('dashboard'); 
            } catch(e) { 
                console.warn(e);
                // Fallback for demo if auth blocked
                user = { uid: 'offline_teacher', isAnonymous: true };
                window.switchScreen('dashboard');
            } finally {
                btn.innerText = "–í–õ–ï–ó";
            }
        };
        
        window.handleLogout = () => signOut(auth);

        // --- TEACHER ---
        const getPublicDoc = (col, id) => doc(db, 'artifacts', appId, 'public', 'data', col, id);
        const getPublicCollection = (name) => collection(db, 'artifacts', appId, 'public', 'data', name);
        const getUserDoc = (uid, col, id) => doc(db, 'artifacts', appId, 'users', uid, col, id);
        const getUserCollection = (uid, col) => collection(db, 'artifacts', appId, 'users', uid, col);

        window.loadTeacherData = () => { 
            // Local Storage only for stability in this environment
            const localLessons = JSON.parse(localStorage.getItem('my_lessons') || '[]');
            const list = document.getElementById('my-quizzes-list'); 
            if(localLessons.length === 0) { list.innerHTML = `<div class="col-span-full py-12 text-center text-slate-400 font-bold bg-white rounded-[2rem] border-4 border-dashed border-slate-100 uppercase tracking-widest text-[10px]">–ù—è–º–∞—Ç–µ —É—Ä–æ—Ü–∏. –°—ä–∑–¥–∞–π—Ç–µ –Ω–æ–≤!</div>`; return; } 
            
            list.innerHTML = localLessons.map((l, index) => { 
                const code = btoa(unescape(encodeURIComponent(JSON.stringify({slides: l.slides, title: l.title})))); 
                return `<div class="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm flex flex-col hover:shadow-xl transition-all"><h4 class="font-black text-lg mb-2 line-clamp-1 text-slate-800">${l.title}</h4><span class="text-[10px] font-black text-slate-400 mb-6 uppercase tracking-widest border border-slate-100 rounded-full px-3 py-1 w-fit">${l.slides?.length||0} –°–õ–ê–ô–î–ê</span><div class="flex gap-2 mt-auto pt-4 border-t border-slate-100"><button onclick="window.startLiveSessionHost(${index})" class="flex-1 py-3 bg-brand-600 hover:bg-brand-700 text-white rounded-xl font-black text-[10px] uppercase shadow-lg transition-all active:scale-95">–°–¢–ê–†–¢</button><button onclick="window.showShareModal('${code}')" class="p-3 bg-amber-50 text-amber-600 hover:bg-amber-100 rounded-xl transition-colors"><i data-lucide="link" class="w-5 h-5"></i></button><button onclick="window.editLesson(${index})" class="p-3 bg-slate-50 text-slate-500 hover:bg-slate-100 rounded-xl transition-colors"><i data-lucide="pencil" class="w-5 h-5"></i></button><button onclick="window.deleteLesson(${index})" class="p-3 bg-rose-50 text-rose-500 hover:bg-rose-100 rounded-xl transition-colors"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div></div>`; 
            }).join(''); 
            lucide.createIcons(); 
        };
        
        window.deleteLesson = (index) => { 
            if(confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ?")) {
                let lessons = JSON.parse(localStorage.getItem('my_lessons') || '[]');
                lessons.splice(index, 1);
                localStorage.setItem('my_lessons', JSON.stringify(lessons));
                window.loadTeacherData();
            }
        };
        
        window.showShareModal = (code) => { document.getElementById('share-code-area').value = code; document.getElementById('modal-share').classList.remove('hidden'); document.getElementById('modal-share').classList.add('flex'); };
        window.doCopyCode = () => { document.getElementById('share-code-area').select(); document.execCommand('copy'); alert("–ö–æ–¥—ä—Ç –µ –∫–æ–ø–∏—Ä–∞–Ω!"); };

        // --- EDITOR LOGIC ---
        window.initCreateMode = () => { currentLessonId = null; slides = []; document.getElementById('lesson-title').value = ""; window.switchScreen('editor'); window.renderSlideList(); };
        
        window.editLesson = (index) => {
            const lessons = JSON.parse(localStorage.getItem('my_lessons') || '[]');
            const data = lessons[index];
            if(data) {
                currentLessonId = index; slides = data.slides || []; document.getElementById('lesson-title').value = data.title;
                window.switchScreen('editor'); window.renderSlideList(); if(slides.length > 0) window.selectSlide(0);
            }
        };

        window.renderSlideList = () => { const container = document.getElementById('slides-list'); container.innerHTML = slides.map((s, i) => `<div onclick="window.selectSlide(${i})" class="slide-item ${i===activeSlideIdx ? 'ring-2 ring-brand-500 bg-brand-50' : 'bg-white'}"><div class="w-6 h-6 rounded-lg ${s.type==='title'?'bg-purple-100 text-purple-600':s.type==='content'?'bg-slate-200 text-slate-500':'bg-brand-100 text-brand-600'} flex items-center justify-center text-xs font-black">${i+1}</div><span class="text-xs font-bold truncate flex-1">${s.title || (s.type==='content'?'–ò–Ω—Ñ–æ':'–í—ä–ø—Ä–æ—Å')}</span><button onclick="event.stopPropagation(); window.deleteSlide(${i})" class="text-slate-300 hover:text-rose-500"><i data-lucide="x" class="w-3 h-3"></i></button></div>`).join(''); lucide.createIcons(); };
        
        window.addSlide = (type) => { 
            let newSlide = { type, title: '–ù–æ–≤ –°–ª–∞–π–¥' };
            if (type === 'title') newSlide = { ...newSlide, subtitle: '', image: '' };
            if (type === 'standard') newSlide = { ...newSlide, title: '–°—ä–¥—ä—Ä–∂–∞–Ω–∏–µ', content: '', image: '', layout: 'left' }; // Text + Image
            if (type === 'background') newSlide = { ...newSlide, title: '–§–æ–Ω + –¢–µ–∫—Å—Ç', content: '', image: '', layout: 'center', textColor: '#1e293b', boxColor: '#ffffff', boxOpacity: 0.9, fontSize: '1.5rem' }; // Cover
            if (type === 'question') newSlide = { ...newSlide, title: '–í—ä–ø—Ä–æ—Å', qType: 'single', options: ['A','B','C','D'], correct: 0, points: 1, questionImage: '' };
            if (type === 'labeling') newSlide = { ...newSlide, title: '–ï—Ç–∏–∫–µ—Ç–∏—Ä–∞–Ω–µ', labels: [], targets: [] }; 
            slides.push(newSlide); window.renderSlideList(); window.selectSlide(slides.length - 1); 
        };
        window.deleteSlide = (i) => { slides.splice(i, 1); window.renderSlideList(); document.getElementById('slide-editor-container').innerHTML = '<p class="text-center text-slate-400 mt-20">–ò–∑–±–µ—Ä–µ—Ç–µ —Å–ª–∞–π–¥...</p>'; };
        
        window.selectSlide = (i) => { activeSlideIdx = i; window.renderSlideList(); const s = slides[i]; const container = document.getElementById('slide-editor-container'); let html = `<div class="space-y-4"><input type="text" oninput="window.updateSlide(${i}, 'title', this.value)" value="${s.title}" class="w-full text-2xl font-black text-slate-800 border-b-2 border-slate-200 focus:border-brand-500 outline-none pb-2 bg-transparent" placeholder="–ó–∞–≥–ª–∞–≤–∏–µ...">`;
            
            if (s.type === 'title') {
                html += `<input type="text" oninput="window.updateSlide(${i}, 'subtitle', this.value)" value="${s.subtitle||''}" class="w-full p-4 bg-slate-50 rounded-xl border border-slate-200" placeholder="–ü–æ–¥–∑–∞–≥–ª–∞–≤–∏–µ...">
                <input type="text" oninput="window.updateSlide(${i}, 'image', this.value)" value="${s.image||''}" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 text-xs" placeholder="URL –Ω–∞ —Ñ–æ–Ω–æ–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">`;
            } else if (s.type === 'standard') {
                html += `<div class="flex gap-2"><label class="text-[10px] uppercase font-black text-slate-400">–°–Ω–∏–º–∫–∞ –ü–æ–∑–∏—Ü–∏—è</label><select onchange="window.updateSlide(${i}, 'layout', this.value)" class="p-2 bg-slate-50 border rounded-lg font-bold text-xs"><option value="left" ${s.layout==='left'?'selected':''}>–õ—è–≤–æ</option><option value="right" ${s.layout==='right'?'selected':''}>–î—è—Å–Ω–æ</option><option value="top" ${s.layout==='top'?'selected':''}>–ì–æ—Ä–µ</option><option value="bottom" ${s.layout==='bottom'?'selected':''}>–î–æ–ª—É</option></select></div>
                <textarea oninput="window.updateSlide(${i}, 'content', this.value)" class="w-full h-32 p-4 bg-slate-50 rounded-xl border border-slate-200 resize-none outline-none focus:border-brand-500" placeholder="–¢–µ–∫—Å—Ç...">${s.content||''}</textarea>
                <input type="text" oninput="window.updateSlide(${i}, 'image', this.value)" value="${s.image||''}" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 text-xs" placeholder="URL –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">`;
            } else if (s.type === 'background') { // Cover Slide with advanced formatting
                html += `
                <!-- Compact Toolbar -->
                <div class="flex items-center gap-4 bg-slate-50 p-2 rounded-xl border border-slate-200 overflow-x-auto">
                    <div class="flex items-center gap-1"><i data-lucide="type" class="w-3 h-3 text-slate-400"></i><input type="color" onchange="window.updateSlide(${i}, 'textColor', this.value)" value="${s.textColor||'#1e293b'}" class="w-6 h-6 rounded cursor-pointer border-none bg-transparent" title="–¶–≤—è—Ç –¢–µ–∫—Å—Ç"></div>
                    <div class="flex items-center gap-1"><i data-lucide="box" class="w-3 h-3 text-slate-400"></i><input type="color" onchange="window.updateSlide(${i}, 'boxColor', this.value)" value="${s.boxColor||'#ffffff'}" class="w-6 h-6 rounded cursor-pointer border-none bg-transparent" title="–¶–≤—è—Ç –ö—É—Ç–∏—è"></div>
                    <select onchange="window.updateSlide(${i}, 'fontSize', this.value)" class="compact-control w-20"><option value="1rem" ${s.fontSize==='1rem'?'selected':''}>–ú–∞–ª—ä–∫</option><option value="1.5rem" ${s.fontSize==='1.5rem'?'selected':''}>–°—Ä–µ–¥–µ–Ω</option><option value="2.5rem" ${s.fontSize==='2.5rem'?'selected':''}>–ì–æ–ª—è–º</option><option value="4rem" ${s.fontSize==='4rem'?'selected':''}>–û–≥—Ä–æ–º–µ–Ω</option></select>
                    <div class="flex items-center gap-1 w-24"><i data-lucide="eye" class="w-3 h-3 text-slate-400"></i><input type="range" min="0" max="1" step="0.1" value="${s.boxOpacity||0.9}" oninput="window.updateSlide(${i}, 'boxOpacity', this.value)" class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer"></div>
                    <select onchange="window.updateSlide(${i}, 'layout', this.value)" class="compact-control w-20"><option value="center" ${s.layout==='center'?'selected':''}>–¶–µ–Ω—Ç—ä—Ä</option><option value="top" ${s.layout==='top'?'selected':''}>–ì–æ—Ä–µ</option><option value="bottom" ${s.layout==='bottom'?'selected':''}>–î–æ–ª—É</option><option value="left" ${s.layout==='left'?'selected':''}>–õ—è–≤–æ</option><option value="right" ${s.layout==='right'?'selected':''}>–î—è—Å–Ω–æ</option></select>
                </div>
                <textarea oninput="window.updateSlide(${i}, 'content', this.value)" class="w-full h-32 p-4 bg-white rounded-xl border border-slate-200 resize-none outline-none focus:border-brand-500" placeholder="–¢–µ–∫—Å—Ç –≤—ä—Ä—Ö—É —Ñ–æ–Ω–∞...">${s.content||''}</textarea>
                <input type="text" oninput="window.updateSlide(${i}, 'image', this.value)" value="${s.image||''}" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 text-xs" placeholder="URL –Ω–∞ —Ñ–æ–Ω–æ–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
                
                <div class="w-full h-48 rounded-xl relative mt-4 overflow-hidden border border-slate-300 bg-slate-200 slide-bg-cover" style="background-image: url('${s.image||''}');">
                     <div class="absolute inset-0 flex p-4 ${s.layout==='center'?'items-center justify-center':s.layout==='top'?'items-start justify-center':s.layout==='bottom'?'items-end justify-center':s.layout==='left'?'items-center justify-start':'items-center justify-end'}">
                        <div style="background-color: ${hexToRgba(s.boxColor||'#ffffff', s.boxOpacity||0.9)}; color: ${s.textColor||'#000'}; font-size: 1rem; padding: 10px; border-radius: 8px; text-align: center; max-width: 60%;">${s.content || '–ü—Ä–µ–≥–ª–µ–¥'}</div>
                     </div>
                </div>`;
            } else if (s.type === 'question') {
                html += `<input type="text" oninput="window.updateSlide(${i}, 'questionImage', this.value)" value="${s.questionImage||''}" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 text-xs mb-2" placeholder="URL –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫—ä–º –≤—ä–ø—Ä–æ—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª–Ω–æ)">
                <div class="grid grid-cols-2 gap-4"><div><label class="text-[10px] uppercase font-black text-slate-400">–¢–∏–ø</label><select onchange="window.updateSlide(${i}, 'qType', this.value); window.selectSlide(${i})" class="w-full p-3 bg-slate-50 border rounded-xl font-bold text-sm"><option value="single" ${s.qType==='single'?'selected':''}>–ï–¥–∏–Ω –í–µ—Ä–µ–Ω</option><option value="boolean" ${s.qType==='boolean'?'selected':''}>–í—è—Ä–Ω–æ/–ì—Ä–µ—à–Ω–æ</option><option value="multiple" ${s.qType==='multiple'?'selected':''}>–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω</option><option value="short" ${s.qType==='short'?'selected':''}>–ö—Ä–∞—Ç—ä–∫ –æ—Ç–≥–æ–≤–æ—Ä</option><option value="ordering" ${s.qType==='ordering'?'selected':''}>–ü–æ–¥—Ä–µ–∂–¥–∞–Ω–µ</option><option value="numeric" ${s.qType==='numeric'?'selected':''}>–ü–ª—ä–∑–≥–∞—á</option><option value="timeline" ${s.qType==='timeline'?'selected':''}>–•—Ä–æ–Ω–æ–ª–æ–≥–∏—è</option></select></div></div><div class="space-y-2 mt-4">`;
                
                if(['single'].includes(s.qType)) {
                    s.options.forEach((opt, oi) => html += `<div class="flex gap-2 items-center"><input type="radio" name="correct" ${s.correct===oi?'checked':''} onchange="window.updateSlide(${i}, 'correct', ${oi})"><input type="text" value="${opt}" oninput="window.updateOption(${i}, ${oi}, this.value)" class="flex-1 p-2 border rounded-lg text-sm"></div>`);
                } else if(s.qType==='boolean') {
                    html += `<div class="flex gap-4 mt-4"><label class="p-4 border rounded-xl w-full text-center cursor-pointer ${s.correct===true?'bg-emerald-50 border-emerald-500':''}"><input type="radio" name="bool" onchange="window.updateSlide(${i}, 'correct', true)" ${s.correct===true?'checked':''} class="hidden"> –í–Ø–†–ù–û</label><label class="p-4 border rounded-xl w-full text-center cursor-pointer ${s.correct===false?'bg-rose-50 border-rose-500':''}"><input type="radio" name="bool" onchange="window.updateSlide(${i}, 'correct', false)" ${s.correct===false?'checked':''} class="hidden"> –ì–†–ï–®–ù–û</label></div>`;
                } else if(s.qType==='multiple') {
                     if(!Array.isArray(s.correct)) s.correct = [];
                     s.options.forEach((opt, oi) => html += `<div class="flex gap-2 items-center"><input type="checkbox" ${s.correct.includes(oi)?'checked':''} onchange="window.toggleCorrect(${i}, ${oi})"><input type="text" value="${opt}" oninput="window.updateOption(${i}, ${oi}, this.value)" class="flex-1 p-2 border rounded-lg text-sm"></div>`);
                } else if(s.qType==='short') {
                     html += `<input type="text" value="${s.correctText||''}" oninput="window.updateSlide(${i}, 'correctText', this.value)" class="w-full p-3 border-2 border-brand-200 rounded-xl" placeholder="–í–µ—Ä–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä (–¥—É–º–∞/—Ñ—Ä–∞–∑–∞)">`;
                } else if(s.qType==='ordering') {
                     html += `<p class="text-xs text-slate-400 mb-2">–ü–æ–¥—Ä–µ–¥–µ—Ç–µ –æ—Ç–≥–æ–≤–æ—Ä–∏—Ç–µ –≤ –ø—Ä–∞–≤–∏–ª–Ω–∏—è —Ä–µ–¥ —Ç—É–∫:</p>`;
                     s.options.forEach((opt, oi) => html += `<div class="flex gap-2 items-center mb-1"><div class="w-6 h-6 bg-slate-200 rounded text-center text-xs font-bold leading-6">${oi+1}</div><input type="text" value="${opt}" oninput="window.updateOption(${i}, ${oi}, this.value)" class="flex-1 p-2 border rounded-lg text-sm"></div>`);
                } else if(s.qType==='timeline' || s.qType==='numeric') {
                     html += `<div class="grid grid-cols-3 gap-2 text-xs"><div>–ú–∏–Ω<input type="number" oninput="window.updateSlide(${i},'min',this.value)" value="${s.min||0}" class="w-full p-1 border"></div><div>–ú–∞–∫—Å<input type="number" oninput="window.updateSlide(${i},'max',this.value)" value="${s.max||100}" class="w-full p-1 border"></div><div>–°—Ç—ä–ø–∫–∞<input type="number" oninput="window.updateSlide(${i},'step',this.value)" value="${s.step||1}" class="w-full p-1 border"></div></div><p class="mt-2 text-xs">–í–µ—Ä–µ–Ω</p><input type="number" oninput="window.updateSlide(${i},'correct',this.value)" value="${s.correct||50}" class="w-full p-2 border rounded">`;
                }
                html += `</div>`;
            } else if (s.type === 'labeling') {
                html += `<input type="text" oninput="window.updateSlide(${i}, 'image', this.value); window.selectSlide(${i})" value="${s.image||''}" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 text-xs mb-4" placeholder="URL –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ –∑–∞ –µ—Ç–∏–∫–µ—Ç–∏—Ä–∞–Ω–µ">
                ${s.image ? `<div class="relative w-full h-64 bg-slate-100 rounded-xl overflow-hidden cursor-crosshair border border-slate-300" onclick="window.addLabelTarget(event, ${i})"><img src="${s.image}" class="w-full h-full object-contain"><div id="editor-targets-layer"></div></div><p class="text-[10px] text-slate-400 mt-1">–ö–ª–∏–∫–Ω–µ—Ç–µ –≤—ä—Ä—Ö—É —Å–Ω–∏–º–∫–∞—Ç–∞, –∑–∞ –¥–∞ –¥–æ–±–∞–≤–∏—Ç–µ –∑–æ–Ω–∞.</p><div class="mt-4 space-y-2" id="labels-inputs"></div>` : ''}`;
                setTimeout(() => window.renderLabelInputs(i), 0);
            }
            html += `</div>`; container.innerHTML = html; lucide.createIcons();
        };

        window.updateSlide = (i, field, val) => { slides[i][field] = val; if(field==='title') window.renderSlideList(); if(field.includes('Color')||field==='boxOpacity'||field==='layout'||field==='fontSize') window.selectSlide(i); };
        window.updateOption = (i, oi, val) => { slides[i].options[oi] = val; };
        window.toggleCorrect = (i, oi) => { const s = slides[i]; if(!Array.isArray(s.correct)) s.correct = []; if(s.correct.includes(oi)) s.correct = s.correct.filter(x => x!==oi); else s.correct.push(oi); };
        
        window.addLabelTarget = (e, i) => { const rect = e.currentTarget.getBoundingClientRect(); const x = ((e.clientX - rect.left) / rect.width) * 100; const y = ((e.clientY - rect.top) / rect.height) * 100; if(!slides[i].targets) slides[i].targets = []; slides[i].targets.push({ x, y, text: `–ï—Ç–∏–∫–µ—Ç ${slides[i].targets.length + 1}` }); window.selectSlide(i); };
        window.renderLabelInputs = (i) => { const s = slides[i]; if(!s.targets) return; const layer = document.getElementById('editor-targets-layer'); const inputs = document.getElementById('labels-inputs'); layer.innerHTML = s.targets.map((t, ti) => `<div style="left:${t.x}%; top:${t.y}%;" class="absolute w-6 h-6 bg-brand-600 rounded-full border-2 border-white transform -translate-x-1/2 -translate-y-1/2 shadow-md flex items-center justify-center text-white text-xs font-bold">${ti+1}</div>`).join(''); inputs.innerHTML = s.targets.map((t, ti) => `<div class="flex gap-2 items-center"><div class="w-6 h-6 bg-brand-600 rounded-full text-white flex items-center justify-center text-xs font-bold">${ti+1}</div><input type="text" value="${t.text}" oninput="slides[${i}].targets[${ti}].text = this.value" class="flex-1 p-2 border rounded-lg text-sm"><button onclick="slides[${i}].targets.splice(${ti},1); window.selectSlide(${i})" class="text-rose-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`).join(''); lucide.createIcons(); };

        // SAVE & LOAD (LOCAL STORAGE)
        window.downloadLesson = () => { const data = JSON.stringify({ title: document.getElementById('lesson-title').value, slides }); const url = URL.createObjectURL(new Blob([data], {type: 'application/json'})); const a = document.createElement('a'); a.href = url; a.download = 'lesson.json'; a.click(); };
        window.importLessonFromFile = (input) => { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (e) => { const data = JSON.parse(e.target.result); currentLessonId = null; slides = data.slides; window.initCreateMode(); document.getElementById('lesson-title').value = data.title; window.renderSlideList(); window.selectSlide(0); }; reader.readAsText(file); };
        
        window.saveLessonToCloud = async () => { 
             const title = document.getElementById('lesson-title').value || "–ë–µ–∑ –∏–º–µ"; 
             const data = { title, slides };
             
             let lessons = JSON.parse(localStorage.getItem('my_lessons') || '[]');
             if(currentLessonId !== null) {
                 lessons[currentLessonId] = data;
             } else {
                 lessons.push(data);
             }
             localStorage.setItem('my_lessons', JSON.stringify(lessons));
             window.switchScreen('dashboard');
        };

        // --- HOST (LIVE) ---
        window.startLiveSessionHost = async (index) => {
            const lessons = JSON.parse(localStorage.getItem('my_lessons') || '[]');
            const lesson = lessons[index];
            if(!lesson) return;
            
            sessionID = Math.floor(1000 + Math.random() * 9000).toString();
            window.switchScreen('live-host'); document.getElementById('host-pin-display').innerText = sessionID;
            
            // Upload to PUBLIC session collection for students
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', sessionID), { status: 'waiting', pin: sessionID, title: lesson.title, slides: lesson.slides, activeSlide: -1, timestamp: serverTimestamp() });
            
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'sessions', sessionID, 'participants'), s => { document.getElementById('host-count').innerText = s.size; });
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(window.location.origin + window.location.pathname + '?pin=' + sessionID)}`; document.getElementById('host-qr-container').innerHTML = `<img src="${qrUrl}" class="mx-auto rounded-xl">`;
        };
        window.startLiveLesson = () => { document.getElementById('host-waiting-screen').classList.add('hidden'); document.getElementById('host-active-slide').classList.remove('hidden'); activeSlideIdx = -1; window.nextLiveSlide(); };
        window.nextLiveSlide = async () => {
             const sessionRef = doc(db, 'artifacts', appId, 'public', 'data', 'sessions', sessionID); const snap = await getDoc(sessionRef); const slides = snap.data().slides;
             activeSlideIdx++; if(activeSlideIdx >= slides.length) { window.finishSession(); return; }
             const s = slides[activeSlideIdx]; document.getElementById('host-slide-num').innerText = `${activeSlideIdx+1} / ${slides.length}`;
             const content = document.getElementById('host-slide-content');
             content.style.backgroundImage = 'none'; content.innerHTML = ''; // Reset

             if(s.type === 'title') {
                 content.style.backgroundImage = s.image ? `url('${s.image}')` : 'none'; content.className = "flex-1 flex flex-col items-center justify-center text-center w-full h-full relative p-12 slide-bg-cover";
                 content.innerHTML = `<div class="bg-white/90 p-12 rounded-3xl shadow-2xl backdrop-blur-sm"><h1 class="text-6xl font-black mb-4">${s.title}</h1><h3 class="text-3xl text-slate-500">${s.subtitle||''}</h3></div>`;
             } else if(s.type === 'standard') {
                 let layoutClass = 'flex-col'; if(s.layout==='left') layoutClass='flex-row-reverse'; if(s.layout==='right') layoutClass='flex-row'; if(s.layout==='bottom') layoutClass='flex-col-reverse';
                 content.className = "flex-1 flex items-center justify-center w-full h-full p-12";
                 content.innerHTML = `<div class="flex ${layoutClass} gap-12 items-center w-full h-full"><div class="flex-1 text-left"><h2 class="text-5xl font-black mb-6 text-slate-800">${s.title}</h2><p class="text-2xl text-slate-600 leading-relaxed">${s.content}</p></div>${s.image?`<div class="flex-1 h-full"><img src="${s.image}" class="w-full h-full object-contain rounded-3xl shadow-2xl"></div>`:''}</div>`;
             } else if(s.type === 'background') {
                 content.style.backgroundImage = s.image ? `url('${s.image}')` : 'none'; content.className = "flex-1 flex flex-col w-full h-full slide-bg-cover relative";
                 const alignClass = s.layout==='top'?'justify-start':s.layout==='bottom'?'justify-end':s.layout==='left'?'justify-center items-start':s.layout==='right'?'justify-center items-end':'justify-center items-center';
                 content.innerHTML = `<div class="flex w-full h-full p-16 ${alignClass}"><div style="background-color: ${hexToRgba(s.boxColor, s.boxOpacity)}; color: ${s.textColor}; font-size: ${s.fontSize}; padding: 3rem; border-radius: 2rem; max-width: 70%; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2);"><p>${s.content}</p></div></div>`;
             } else if(s.type === 'question' || s.type === 'labeling') {
                 content.className = "flex-1 flex flex-col items-center justify-center text-center w-full h-full p-12";
                 content.innerHTML = `<h2 class="text-5xl font-black mb-8">${s.title}</h2>${s.image||s.questionImage?`<img src="${s.image||s.questionImage}" class="h-80 object-contain mb-8 rounded-2xl shadow-xl">`:''}<div class="text-8xl font-black text-brand-600 animate-bounce">?</div>`;
             }
             
             await updateDoc(sessionRef, { status: 'active', activeSlide: activeSlideIdx, currentSlideData: s });
        };
        window.finishSession = () => window.switchScreen('dashboard');
        window.quitHostSession = () => window.switchScreen('dashboard');

        // --- CLIENT ---
        window.joinLiveSession = async () => {
             const pin = document.getElementById('live-pin').value; if(!pin) return alert("PIN?");
             if(!auth.currentUser) await signInAnonymously(auth); sessionID = pin; window.switchScreen('live-client');
             await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', pin, 'participants', auth.currentUser.uid), { name: document.getElementById('live-student-name').value });
             onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', pin), s => {
                const d = s.data();
                if(d.status === 'active') {
                    window.renderClientSlide(d.currentSlideData, 'client');
                }
            });
        };

        window.renderClientSlide = (slide, mode) => {
            document.getElementById('client-waiting').classList.add('hidden'); document.getElementById('client-active-view').classList.remove('hidden');
            document.getElementById('client-slide-title').innerText = slide.title;
            const body = document.getElementById('client-slide-body');
            const btn = document.getElementById('client-action-btn');
            const nextFn = mode === 'client' ? () => { document.getElementById('client-active-view').classList.add('hidden'); document.getElementById('client-waiting').classList.remove('hidden'); } : window.nextSoloSlide;
            const submitFn = mode === 'client' ? window.submitLiveAnswer : window.nextSoloSlide;

            if(slide.type === 'title' || slide.type === 'standard' || slide.type === 'background') {
                let html = '';
                if(slide.type==='background') {
                    const view = document.getElementById('client-active-view');
                    view.style.backgroundImage = `url('${slide.image}')`; view.style.backgroundSize='cover'; view.style.backgroundPosition='center';
                    html = `<div style="background-color: ${hexToRgba(slide.boxColor, slide.boxOpacity)}; color: ${slide.textColor}; padding: 20px; border-radius: 16px; text-align: center;">${slide.content}</div>`;
                } else {
                    document.getElementById('client-active-view').style.backgroundImage = 'none';
                    html = `${slide.image ? `<img src="${slide.image}" class="w-full rounded-xl mb-4">` : ''}<p class="text-lg text-slate-700">${slide.content||slide.subtitle||''}</p>`;
                }
                body.innerHTML = html;
                btn.innerText = "–ù–ê–ü–†–ï–î"; btn.onclick = nextFn;
                document.getElementById('client-confirm-bar').classList.remove('hidden');
            } else if (slide.type === 'labeling') {
                 window.tempSelectedLabel = null;
                 const targets = slide.targets || [];
                 let html = `<div class="relative w-full mb-4"><img src="${slide.image}" class="w-full rounded-xl shadow-sm">`;
                 targets.forEach((t, i) => html += `<div onclick="window.placeLabel(${i})" class="label-target" id="target-${i}" style="left:${t.x}%; top:${t.y}%;">?</div>`);
                 html += `</div><div class="flex flex-wrap gap-2 justify-center" id="labels-pool">`;
                 targets.forEach((t, i) => html += `<div onclick="window.selectLabel(this, '${t.text}')" class="label-chip">${t.text}</div>`);
                 html += `</div>`;
                 body.innerHTML = html; 
                 btn.innerText = "–ì–û–¢–û–í–û"; btn.onclick = submitFn;
                 document.getElementById('client-confirm-bar').classList.remove('hidden');
            } else {
                body.innerHTML = '';
                if(slide.qType === 'short') {
                    body.innerHTML = `<input type="text" id="short-answer-input" class="w-full p-4 border-2 border-slate-300 rounded-xl text-lg font-bold" placeholder="–í–∞—à–∏—è—Ç –æ—Ç–≥–æ–≤–æ—Ä...">`;
                } else if(slide.qType === 'ordering') {
                     // Simple ordering visualization (items in original order, user clicks to build sequence)
                     body.innerHTML = `<div class="space-y-2" id="order-container"></div>`;
                     // Shuffle logic would be here
                     slide.options.forEach(o => document.getElementById('order-container').innerHTML += `<div class="p-3 bg-white border rounded shadow-sm">${o}</div>`);
                } else {
                    slide.options?.forEach((o, i) => {
                        const type = slide.qType === 'multiple' ? 'checkbox' : 'radio'; // Logic handled via CSS classes usually, simplified here
                        body.innerHTML += `<button class="w-full p-4 bg-white border-2 border-slate-200 rounded-xl mb-3 font-bold shadow-sm active:bg-brand-600 active:text-white" onclick="this.classList.toggle('bg-brand-600'); this.classList.toggle('text-white')">${o}</button>`;
                    });
                }
                btn.innerText = "–ü–û–¢–í–™–†–î–ò"; btn.onclick = submitFn;
                document.getElementById('client-confirm-bar').classList.remove('hidden');
            }
        };

        window.selectLabel = (el, text) => {
            document.querySelectorAll('.label-chip').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            window.tempSelectedLabel = { text, el };
        };

        window.placeLabel = (idx) => {
            if(!window.tempSelectedLabel) return;
            const target = document.getElementById(`target-${idx}`);
            target.innerText = window.tempSelectedLabel.text;
            target.classList.add('filled', 'w-auto', 'px-2', 'rounded-lg');
            window.tempSelectedLabel.el.classList.add('placed');
            window.tempSelectedLabel = null;
        };
        
        window.submitLiveAnswer = () => { document.getElementById('client-active-view').classList.add('hidden'); document.getElementById('client-waiting').classList.remove('hidden'); document.getElementById('client-status-msg').innerText = "–ì–æ—Ç–æ–≤–æ!"; };

        // --- SOLO MODE (CLIENT-SIDE) ---
        window.startIndividual = async () => {
             const code = document.getElementById('ind-quiz-code').value; 
             if(!code) return alert("–ö–æ–¥?");
             try {
                const dec = JSON.parse(decodeURIComponent(escape(atob(code))));
                slides = dec.slides || []; 
                currentLessonId = dec.lessonId;
                activeSlideIdx = -1;
                sopEnabled = document.getElementById('ind-sop-mode').checked;
                window.switchScreen('live-client'); // Reuse client UI
                window.nextSoloSlide();
             } catch(e) { alert("–ù–µ–≤–∞–ª–∏–¥–µ–Ω –∫–æ–¥"); }
        };

        window.nextSoloSlide = () => {
             activeSlideIdx++;
             if(activeSlideIdx >= slides.length) { alert("–ö—Ä–∞–π!"); window.switchScreen('welcome'); return; }
             const s = slides[activeSlideIdx];
             window.renderClientSlide(s, 'solo');
             
             const body = document.getElementById('client-slide-body');
             if(sopEnabled) { 
                 body.classList.add('sop-text');
                 if('speechSynthesis' in window) { const u = new SpeechSynthesisUtterance(s.title + ". " + (s.content||s.text||'')); u.lang='bg-BG'; window.speechSynthesis.speak(u); }
             } else body.classList.remove('sop-text');
        };

        window.addEventListener('DOMContentLoaded', () => { const p = new URLSearchParams(window.location.search).get('pin'); if(p) { window.switchTab('class'); document.getElementById('live-pin').value = p; } });
    </script>
</body>
</html>
