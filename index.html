<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LessonMaster Live (v3.3 ‚Ä¢ Lock/Reveal + Feedback)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { -webkit-font-smoothing: antialiased; }
    .card { border: 1px solid rgb(226 232 240); border-radius: 1.5rem; background: white; box-shadow: 0 10px 25px rgba(0,0,0,.06); }
    .btn { border-radius: 1rem; font-weight: 900; letter-spacing: .08em; text-transform: uppercase; }
    .btn:active { transform: translateY(1px); }
    .muted { color: rgb(100 116 139); }
    .pill { border: 1px solid rgb(226 232 240); border-radius: 999px; padding: .25rem .6rem; font-size: .75rem; font-weight: 900; letter-spacing: .12em; text-transform: uppercase; color: rgb(100 116 139); }
    .opt { border: 2px solid rgb(226 232 240); border-radius: 1rem; padding: 1rem; font-weight: 950; background: white; }
    .opt.selected { border-color: rgb(2 132 199); background: rgb(240 249 255); }
    .disabled { opacity: .6; pointer-events: none; }
    code { background: rgb(241 245 249); padding: .1rem .25rem; border-radius: .4rem; }

    /* Host slide surface */
    .slide-surface {
      position: relative;
      border-radius: 1.5rem;
      overflow: hidden;
      min-height: 520px;
      border: 1px solid rgb(226 232 240);
      box-shadow: 0 10px 25px rgba(0,0,0,.06);
      background: white;
    }
    .slide-bg { position: absolute; inset: 0; background-size: cover; background-position: center; background-repeat: no-repeat; }
    .slide-overlay { position: absolute; inset: 0; background: rgba(0,0,0,.35); }
    .slide-content { position: relative; padding: 2rem; height: 100%; color: rgb(15 23 42); display:flex; flex-direction:column; justify-content:center; gap: 1.25rem; }
    .slide-card {
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(226,232,240,.9);
      border-radius: 1.25rem;
      padding: 1.75rem;
      box-shadow: 0 12px 28px rgba(0,0,0,.14);
      backdrop-filter: blur(6px);
      max-width: 1200px;
      margin: 0 auto;
    }
    .slide-title { font-weight: 950; letter-spacing: -.02em; line-height: 1.05; }
    .slide-text { font-weight: 850; color: rgb(51 65 85); line-height: 1.55; }
    .img-frame {
      border-radius: 1.25rem;
      overflow: hidden;
      border: 1px solid rgba(226,232,240,.9);
      box-shadow: 0 12px 28px rgba(0,0,0,.14);
      background: rgba(255,255,255,.85);
    }
    .img-frame img { width: 100%; height: 100%; object-fit: contain; display: block; }

    /* Classroom presentation mode */
    body.present { background: #020617; }
    body.present header,
    body.present #screen-welcome { display:none !important; }
    body.present #host-top-card,
    body.present #host-stats { display:none !important; }
    body.present #screen-host { padding: 0 !important; margin: 0 !important; }
    body.present .present-shell {
      position: fixed; inset: 0;
      display: flex; flex-direction: column;
      background: #020617;
    }
    body.present .present-stage {
      flex: 1;
      padding: 1.1rem;
      display:flex;
    }
    body.present .slide-surface {
      border-radius: 1.25rem;
      border: 2px solid rgba(255,255,255,.10);
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      width: 100%;
      min-height: calc(100vh - 110px);
    }
    body.present .slide-content { padding: 3.2rem; }
    body.present .slide-card { background: rgba(255,255,255,.94); padding: 2.25rem; max-width: 1500px; }
    body.present .present-controls {
      height: 90px;
      border-top: 1px solid rgba(255,255,255,.08);
      background: rgba(2,6,23,.92);
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 0.9rem 1.2rem;
      gap: 1rem;
    }
    body.present .present-badge {
      display:flex; gap: 14px; align-items:center; color: rgba(255,255,255,.85);
      font-weight: 950; letter-spacing: .12em; text-transform: uppercase; font-size: 12px;
      flex-wrap: wrap;
    }
    body.present .present-badge span.value {
      font-size: 22px; letter-spacing: .02em; text-transform: none; color:white;
    }
    body.present .present-actions { display:flex; gap: 10px; flex-wrap: wrap; }
    body.present .present-actions button, body.present .present-actions select {
      border-radius: 999px; padding: 14px 18px; font-size: 13px; font-weight: 950;
      letter-spacing: .14em; text-transform: uppercase;
    }
    body.present .present-actions select { color: #0f172a; background: #e2e8f0; }

    /* Student mobile polish */
    @media (max-width: 640px) {
      .card { border-radius: 1.25rem; }
      .opt { padding: 1.1rem; border-radius: 1rem; font-size: 1.05rem; }
      #student-interaction { padding-bottom: 104px; }
      #btn-student-submit { position: fixed; left: 16px; right: 16px; bottom: 14px; z-index: 50; border-radius: 1.25rem; }
      #student-sent { margin-bottom: 86px; }
      #student-feedback { margin-bottom: 86px; }
    }

    /* Labeling */
    .label-target {
      position: absolute; width: 40px; height: 40px;
      background: rgba(255,255,255,0.96);
      border: 4px solid rgb(2 132 199);
      border-radius: 999px;
      transform: translate(-50%, -50%);
      display:flex; align-items:center; justify-content:center;
      font-weight: 950; color: rgb(2 132 199);
      box-shadow: 0 10px 22px rgba(0,0,0,.20);
      cursor: pointer;
      user-select: none;
    }
    .label-target.filled {
      width: auto; height: auto;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgb(2 132 199);
      color: white;
      border-color: white;
    }
    .label-chip {
      padding: 12px 14px;
      border: 2px solid rgb(226 232 240);
      border-radius: 999px;
      background: white;
      font-weight: 950;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }
    .label-chip.selected { border-color: rgb(2 132 199); background: rgb(240 249 255); }
    .label-chip.placed { opacity: .5; pointer-events: none; background: rgb(241 245 249); }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen">
  <div class="max-w-6xl mx-auto p-6 space-y-6">

    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <div class="text-3xl font-black tracking-tight">LessonMaster Live (v3.3)</div>
        <div class="muted font-bold text-sm">Lock ‚Üí Reveal ‚Ä¢ –£—á–µ–Ω–∏—Ü–∏—Ç–µ –≤–∏–∂–¥–∞—Ç —Å–∞–º–æ –≤—è—Ä–Ω–æ/–≥—Ä–µ—à–Ω–æ ‚Ä¢ –†–µ–∑—É–ª—Ç–∞—Ç–∏ —á–∞–∫ –Ω–∞–∫—Ä–∞—è</div>
      </div>
      <div class="flex gap-2 flex-wrap">
        <span id="mode-pill" class="pill">MODE: ‚Äî</span>
        <span id="status-pill" class="pill">STATUS: ‚Äî</span>
      </div>
    </header>

    <!-- WELCOME -->
    <section id="screen-welcome" class="grid md:grid-cols-2 gap-6">
      <!-- STUDENT -->
      <div class="card p-6 space-y-4">
        <div class="text-xl font-black">–£—á–µ–Ω–∏–∫</div>
        <div class="muted font-bold text-sm">–í–ª–∏–∑–∞—à —Å PIN –∏ —á–∞–∫–∞—à –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏—Ç–µ –¥–µ–π–Ω–æ—Å—Ç–∏.</div>

        <div class="space-y-2">
          <label class="text-xs font-black uppercase tracking-widest muted">–ò–º–µ</label>
          <input id="student-name" class="w-full p-4 rounded-2xl border-2 border-slate-200 font-bold outline-none focus:border-sky-600" placeholder="–ù–∞–ø—Ä. –ú–∞—Ä–∏—è" />
        </div>

        <div class="space-y-2">
          <label class="text-xs font-black uppercase tracking-widest muted">PIN</label>
          <input id="student-pin" class="w-full p-4 rounded-2xl border-2 border-slate-200 font-black text-2xl tracking-[.2em] outline-none focus:border-sky-600" placeholder="1234" inputmode="numeric" />
        </div>

        <button id="btn-student-join" class="btn w-full py-4 bg-sky-600 hover:bg-sky-700 text-white">–í–ª–µ–∑</button>

        <div class="muted text-xs font-bold">
          –ê–∫–æ –æ—Ç–≤–æ—Ä–∏—à –ª–∏–Ω–∫–∞ —Å <code>?pin=1234</code>, PIN —Å–µ –ø–æ–ø—ä–ª–≤–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.
        </div>
      </div>

      <!-- HOST -->
      <div class="card p-6 space-y-4 bg-slate-900 text-white border-0">
        <div class="text-xl font-black">–•–æ—Å—Ç (—É—á–∏—Ç–µ–ª)</div>
        <div class="text-slate-300 font-bold text-sm">–°—Ç–∞—Ä—Ç–∏—Ä–∞—à —Å–µ—Å–∏—è –∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–∞—à —Ç–µ–º–ø–æ—Ç–æ.</div>

        <div class="space-y-2">
          <label class="text-xs font-black uppercase tracking-widest text-slate-400">–ü–∞—Ä–æ–ª–∞ (—Ç–µ—Å—Ç)</label>
          <input id="teacher-pass" type="password" class="w-full p-4 rounded-2xl bg-white/10 border-2 border-white/10 font-bold outline-none focus:border-sky-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>

        <div class="grid grid-cols-2 gap-3">
          <button id="btn-host-login" class="btn py-4 bg-sky-600 hover:bg-sky-500 text-white">–í—Ö–æ–¥</button>
          <button id="btn-load-demo" class="btn py-4 bg-white/10 hover:bg-white/15 text-white">Demo —É—Ä–æ–∫</button>
        </div>

        <div class="text-slate-300 text-xs font-bold">
          Classroom Mode: ‚ÄúFullscreen‚Äù –ø—Ä–∞–≤–∏ –µ–∫—Ä–∞–Ω–∞ –∑–∞ –ø—Ä–æ–µ–∫—Ç–æ—Ä/–¥—ä—Å–∫–∞.
        </div>
      </div>
    </section>

    <!-- HOST -->
    <section id="screen-host" class="hidden space-y-6">
      <div id="host-top-card" class="card p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div class="space-y-1">
            <div class="text-sm font-black uppercase tracking-widest muted">–°–µ—Å–∏—è</div>
            <div class="text-4xl font-black tracking-tight">
              PIN: <span id="host-pin" class="text-sky-700">‚Äî</span>
            </div>
            <div class="muted font-bold text-sm">
              Join link:
              <span id="host-join-link" class="font-black break-all"></span>
            </div>
            <div class="muted font-bold text-xs">
              lessonId: <span id="host-lesson-id" class="font-black">‚Äî</span>
            </div>
          </div>

          <div class="flex gap-2 flex-wrap items-center">
            <label class="pill">TEXT
              <select id="host-font-preset" class="ml-2 bg-slate-100 rounded-full px-3 py-1 font-black text-xs" title="–†–∞–∑–º–µ—Ä –∑–∞ –∑–∞–ª–∞/–ø—Ä–æ–µ–∫—Ç–æ—Ä">
                <option value="standard">Standard</option>
                <option value="large" selected>Large</option>
                <option value="xlarge">XL</option>
              </select>
            </label>
            <button id="btn-host-start" class="btn px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white">Start</button>
            <button id="btn-host-next" class="btn px-6 py-3 bg-slate-800 hover:bg-black text-white">Next</button>
            <button id="btn-host-lock" class="btn px-6 py-3 bg-amber-500 hover:bg-amber-600 text-white">Lock</button>
            <button id="btn-host-reveal" class="btn px-6 py-3 bg-sky-600 hover:bg-sky-700 text-white">Reveal</button>
            <button id="btn-host-attn" class="btn px-6 py-3 bg-violet-600 hover:bg-violet-700 text-white">Attention</button>
            <button id="btn-host-full" class="btn px-6 py-3 bg-slate-200 hover:bg-slate-300 text-slate-900">Fullscreen</button>
            <button id="btn-host-end" class="btn px-6 py-3 bg-rose-500 hover:bg-rose-600 text-white">End</button>
          </div>
        </div>
      </div>

      <div class="grid lg:grid-cols-3 gap-6">
        <!-- Host slide -->
        <div class="lg:col-span-2">
          <div class="flex items-center justify-between mb-3">
            <div class="space-y-1">
              <div class="pill inline-block">HOST VIEW</div>
              <div id="host-slide-title" class="text-2xl font-black mt-2">‚Äî</div>
              <div id="host-slide-meta" class="muted font-bold text-sm">‚Äî</div>
            </div>
            <div class="text-right">
              <div class="muted text-xs font-black uppercase tracking-widest">–°–ª–∞–π–¥</div>
              <div id="host-slide-counter" class="text-2xl font-black">‚Äî</div>
            </div>
          </div>

          <div class="slide-surface">
            <div id="host-bg" class="slide-bg"></div>
            <div id="host-overlay" class="slide-overlay"></div>
            <div id="host-slide-surface" class="slide-content">
              <div class="slide-card">
                <div class="text-xl font-black">–°—Ç–∞—Ä—Ç–∏—Ä–∞–π —Å–µ—Å–∏—è –∏ –Ω–∞—Ç–∏—Å–Ω–∏ Start.</div>
                <div class="muted font-bold mt-2">–£—á–µ–Ω–∏—Ü–∏—Ç–µ —â–µ –≤–∏–∂–¥–∞—Ç —Å–∞–º–æ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏—Ç–µ –¥–µ–π–Ω–æ—Å—Ç–∏.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Stats -->
        <div id="host-stats" class="card p-6">
          <div class="pill inline-block mb-4">LIVE STATS</div>

          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <div class="muted font-black uppercase tracking-widest text-xs">–£—á–µ–Ω–∏—Ü–∏</div>
              <div id="stat-participants" class="text-xl font-black">0</div>
            </div>

            <div class="flex items-center justify-between">
              <div class="muted font-black uppercase tracking-widest text-xs">–û—Ç–≥–æ–≤–æ—Ä–∏–ª–∏</div>
              <div id="stat-answered" class="text-xl font-black">0</div>
            </div>
          </div>

          <div class="mt-4 border-t pt-4">
            <div class="muted font-black uppercase tracking-widest text-xs mb-2">MCQ / Multi</div>
            <div id="stat-mcq" class="space-y-2 muted font-bold text-sm"><div>‚Äî</div></div>
          </div>

          <div class="mt-4 border-t pt-4">
            <div class="muted font-black uppercase tracking-widest text-xs mb-2">Short (–ø—Ä–µ–≥–ª–µ–¥)</div>
            <div id="stat-short" class="space-y-2 text-sm"><div class="muted font-bold">‚Äî</div></div>
          </div>

          <div class="mt-4 border-t pt-4">
            <div class="muted font-black uppercase tracking-widest text-xs mb-2">Labeling</div>
            <div id="stat-labeling" class="muted font-bold text-sm">‚Äî</div>
          </div>
        </div>
      </div>
    </section>

    <!-- STUDENT -->
    <section id="screen-student" class="hidden space-y-6">
      <div class="card p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <div class="pill inline-block">STUDENT VIEW</div>
            <div class="text-2xl font-black mt-3">PIN: <span id="student-pin-active" class="text-sky-700">‚Äî</span></div>
            <div class="muted font-bold text-sm">–ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–∑–ª–∏–∑–∞—Ç —Å–∞–º–æ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏—Ç–µ –¥–µ–π–Ω–æ—Å—Ç–∏.</div>
          </div>
          <button id="btn-student-leave" class="btn px-6 py-3 bg-slate-800 hover:bg-black text-white">–ò–∑—Ö–æ–¥</button>
        </div>
      </div>

      <!-- Waiting -->
      <div id="student-waiting" class="card p-10 text-center">
        <div class="text-6xl mb-4">üëÄ</div>
        <div id="student-waiting-msg" class="text-2xl font-black">–ì–ª–µ–¥–∞–π –µ–∫—Ä–∞–Ω–∞ –æ—Ç–ø—Ä–µ–¥‚Ä¶</div>
        <div class="muted font-bold mt-2">–ö–æ–≥–∞—Ç–æ –∑–∞–ø–æ—á–Ω–µ –¥–µ–π–Ω–æ—Å—Ç, —Ç—É–∫ —â–µ —Å–µ –ø–æ—è–≤–∏.</div>
      </div>

      <!-- Interaction -->
      <div id="student-interaction" class="hidden card p-6">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="pill inline-block">–ê–ö–¢–ò–í–ù–ê –î–ï–ô–ù–û–°–¢</div>
            <div id="student-q-title" class="text-2xl font-black mt-3">‚Äî</div>
            <div id="student-q-sub" class="muted font-bold text-sm mt-1">‚Äî</div>
          </div>
          <div class="text-right">
            <div class="muted text-xs font-black uppercase tracking-widest">–°—Ç–∞—Ç—É—Å</div>
            <div id="student-phase" class="text-xl font-black">‚Äî</div>
          </div>
        </div>

        <div id="student-q-body" class="mt-6"></div>

        <div class="mt-6 flex gap-3">
          <button id="btn-student-submit" class="btn flex-1 py-4 bg-sky-600 hover:bg-sky-700 text-white">–ü–æ—Ç–≤—ä—Ä–¥–∏</button>
        </div>

        <div id="student-sent" class="hidden mt-4 p-4 rounded-2xl bg-emerald-50 text-emerald-700 font-black">
          –ò–∑–ø—Ä–∞—Ç–µ–Ω–æ ‚úÖ
        </div>

        <div id="student-feedback" class="hidden mt-4 p-4 rounded-2xl font-black">
          ‚Äî
        </div>
      </div>
    </section>

  </div>

  <!-- Presentation shell -->
  <div id="present-shell" class="present-shell hidden">
    <div class="present-stage">
      <div class="slide-surface">
        <div id="present-bg" class="slide-bg"></div>
        <div id="present-overlay" class="slide-overlay"></div>
        <div id="present-surface" class="slide-content"></div>
      </div>
    </div>
    <div class="present-controls">
      <div class="present-badge">
        <span>PIN</span> <span class="value" id="present-pin">‚Äî</span>
        <span style="opacity:.5;">|</span>
        <span>–°–ª–∞–π–¥</span> <span class="value" id="present-counter">‚Äî</span>
        <span style="opacity:.5;">|</span>
        <span>–û—Ç–≥–æ–≤–æ—Ä–∏–ª–∏</span> <span class="value" id="present-answered">0/0</span>
      </div>
      <div class="present-actions">
        <select id="present-font-preset" title="–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç">
          <option value="standard">Standard</option>
          <option value="large" selected>Large</option>
          <option value="xlarge">XL</option>
        </select>
        <button id="present-lock" class="bg-amber-500 hover:bg-amber-600 text-white">Lock</button>
        <button id="present-reveal" class="bg-sky-600 hover:bg-sky-700 text-white">Reveal</button>
        <button id="present-attn" class="bg-violet-600 hover:bg-violet-700 text-white">Attention</button>
        <button id="present-next" class="bg-slate-200 hover:bg-slate-300 text-slate-900">Next</button>
        <button id="present-exit" class="bg-rose-500 hover:bg-rose-600 text-white">Exit</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // === CONFIG ===
    const appId = 'lessonmaster-live-test';
    let firebaseConfig;
    try { firebaseConfig = JSON.parse(__firebase_config); }
    catch (e) {
      // ‚¨áÔ∏è –°–õ–û–ñ–ò –¢–£–ö –¢–í–û–Ø firebaseConfig (Project settings ‚Üí Web app)
      firebaseConfig = {
        apiKey: "AIzaSyDPhxwYb2LmW-tYj3xtl5drDbrNjzZFeGw",
        authDomain: "lesson-master-b0ef4.firebaseapp.com",
        projectId: "lesson-master-b0ef4"
      };
    }
    const TEACHER_PASSWORD = 'vilidaf76'; // —Ç–µ—Å—Ç–æ–≤–æ

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Firestore paths
    const sessionDocRef = (pin) => doc(db, 'artifacts', appId, 'public', 'data', 'sessions', pin);
    const lessonsDocRef = (lessonId) => doc(db, 'artifacts', appId, 'public', 'data', 'lessons', lessonId);
    const participantsColRef = (pin) => collection(db, 'artifacts', appId, 'public', 'data', 'sessions', pin, 'participants');
    const participantDocRef = (pin, uid) => doc(db, 'artifacts', appId, 'public', 'data', 'sessions', pin, 'participants', uid);
    const answersColRef = (pin, slideIdx) => collection(db, 'artifacts', appId, 'public', 'data', 'sessions', pin, 'responses', String(slideIdx), 'answers');
    const answerDocRef = (pin, slideIdx, uid) => doc(db, 'artifacts', appId, 'public', 'data', 'sessions', pin, 'responses', String(slideIdx), 'answers', uid);

    const FONT_PRESETS = { standard: 1.00, large: 1.18, xlarge: 1.32 };

    // === DEMO LESSON ===
    const demoLesson = {
      title: 'Demo: Lock ‚Üí Reveal',
      theme: {
        backgroundType: 'image',
        backgroundValue: 'https://images.unsplash.com/photo-1529070538774-1843cb3265df?auto=format&fit=crop&w=1600&q=60',
        overlayOpacity: 0.45,
        fontPreset: 'large'
      },
      slides: [
        { visibility: 'host', layout: 'title', content: { title: 'Classroom Mode', subtitle: 'Lock ‚Üí Reveal ‚Ä¢ –£—á–µ–Ω–∏—Ü–∏—Ç–µ –≤–∏–∂–¥–∞—Ç –≤—è—Ä–Ω–æ/–≥—Ä–µ—à–Ω–æ', image: '' } },
        { visibility: 'host', layout: 'content', content: { title: '–ö–∞–∫ –¥–∞ –≤–æ–¥–∏—à', text: '1) –ü–æ–∫–∞–∑–≤–∞—à –≤—ä–ø—Ä–æ—Å ‚Ä¢ 2) –ß–∞–∫–∞—à ‚Ä¢ 3) Lock ‚Ä¢ 4) Reveal ‚Ä¢ 5) Next', image: '' } },
        { visibility: 'students', layout: 'question', content: { title: 'MCQ', text: '–ò–∑–±–µ—Ä–∏ –≤–µ—Ä–Ω–∏—è –æ—Ç–≥–æ–≤–æ—Ä.', image: '' }, interaction: { kind: 'mcq', options: ['–ê', '–ë', '–í', '–ì'], correct: 2 } },
        { visibility: 'students', layout: 'question', content: { title: 'Multi', text: '–ú–∞—Ä–∫–∏—Ä–∞–π –≤—Å–∏—á–∫–∏ –≤–µ—Ä–Ω–∏.', image: '' }, interaction: { kind: 'multi', options: ['A', 'B', 'C', 'D'], correct: [1,3] } },
        { visibility: 'students', layout: 'question', content: { title: 'Short', text: '–ù–∞–ø–∏—à–∏ –µ–¥–Ω–∞ –¥—É–º–∞: "–ø—Ä–∏–º–µ—Ä"', image: '' }, interaction: { kind: 'short', correctText: '–ø—Ä–∏–º–µ—Ä', caseSensitive: false } },
        { visibility: 'students', layout: 'question', content: { title: 'Labeling', text: '–ò–∑–±–µ—Ä–∏ –µ—Ç–∏–∫–µ—Ç –∏ –Ω–∞—Ç–∏—Å–Ω–∏ —Ü–µ–ª.', image: 'https://images.unsplash.com/photo-1523240795612-9a054b0db644?auto=format&fit=crop&w=1400&q=60' },
          interaction: { kind: 'labeling', targets: [ {x:35,y:35,text:'–ï—Ç–∏–∫–µ—Ç 1'}, {x:70,y:55,text:'–ï—Ç–∏–∫–µ—Ç 2'}, {x:50,y:75,text:'–ï—Ç–∏–∫–µ—Ç 3'} ] } },
        { visibility: 'host', layout: 'content', content: { title: '–§–∏–Ω–∞–ª', text: '–°–ª–µ–¥–≤–∞: –∫—Ä–∞–π–Ω–æ –∫–ª–∞—Å–∏—Ä–∞–Ω–µ/—Ä–µ–∑—É–ª—Ç–∞—Ç (–ø–æ –∂–µ–ª–∞–Ω–∏–µ).', image: '' } },
      ]
    };

    // === STATE ===
    let currentUser = null;
    let mode = 'welcome';

    let hostPin = null, hostLessonId = null, hostLesson = null, hostActiveSlideIdx = -1, hostPhase = 'waiting', hostAttention = false;
    let studentPin = null, studentLessonId = null, studentLesson = null, studentActiveSlideIdx = -1, studentPhase = 'waiting', studentAttention = false;
    let hostParticipantsCount = 0, hostAnsweredCount = 0;

    let isPresent = false;

    const lessonCacheKey = (lessonId) => `lm_lesson_cache_${lessonId}`;
    function cacheLesson(lessonId, lessonObj) { try { localStorage.setItem(lessonCacheKey(lessonId), JSON.stringify(lessonObj)); } catch(e) {} }
    function getCachedLesson(lessonId) { try { const raw = localStorage.getItem(lessonCacheKey(lessonId)); return raw ? JSON.parse(raw) : null; } catch(e) { return null; } }

    let unsub = { session: null, participants: null, answers: null, answerMine: null };

    // === UI HELPERS ===
    const $ = (id) => document.getElementById(id);
    const show = (id) => $(id).classList.remove('hidden');
    const hide = (id) => $(id).classList.add('hidden');
    const setPill = (id, text) => $(id).textContent = text;

    function setMode(nextMode) {
      mode = nextMode;
      hide('screen-welcome'); hide('screen-host'); hide('screen-student');
      if (nextMode === 'welcome') show('screen-welcome');
      if (nextMode === 'host') show('screen-host');
      if (nextMode === 'student') show('screen-student');
      setPill('mode-pill', `MODE: ${nextMode.toUpperCase()}`);
    }
    function setStatus(text) { setPill('status-pill', `STATUS: ${text}`); }

    function isInteractiveSlide(slide) {
      return !!(slide && slide.visibility !== 'host' && slide.interaction && ['mcq','multi','short','labeling'].includes(slide.interaction.kind));
    }

    function getFontScale(theme) {
      const preset = theme?.fontPreset || 'large';
      return FONT_PRESETS[preset] || 1.0;
    }

    // === AUTH ===
    onAuthStateChanged(auth, (u) => {
      currentUser = u;
      setStatus(u ? `signed-in (${u.isAnonymous ? 'anon' : 'user'})` : 'signed-out');
    });
    async function ensureAnonAuth() { if (!auth.currentUser) await signInAnonymously(auth); }

    // === HOST FLOW ===
    function genPin() { return String(Math.floor(1000 + Math.random() * 9000)); }
    function genLessonId() { return 'lesson-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2, 8); }

    async function hostLogin() {
      const pw = $('teacher-pass').value;
      if (pw !== TEACHER_PASSWORD) { alert('–ì—Ä–µ—à–Ω–∞ –ø–∞—Ä–æ–ª–∞ (—Ç–µ—Å—Ç).'); return; }
      await ensureAnonAuth();

      const localDemo = JSON.parse(localStorage.getItem('lm_demo_lesson') || 'null');
      hostLesson = localDemo || demoLesson;

      // Sync preset UI from lesson
      const preset = hostLesson?.theme?.fontPreset || 'large';
      $('host-font-preset').value = preset;
      $('present-font-preset').value = preset;

      hostLessonId = genLessonId();
      await setDoc(lessonsDocRef(hostLessonId), {
        lessonId: hostLessonId,
        title: hostLesson.title,
        theme: hostLesson.theme || { backgroundType: 'color', backgroundValue: '#111827', overlayOpacity: 0.45, fontPreset: 'large' },
        slides: hostLesson.slides,
        hostUid: auth.currentUser.uid,
        createdAt: serverTimestamp()
      });

      hostPin = genPin();
      await setDoc(sessionDocRef(hostPin), {
        pin: hostPin,
        title: hostLesson.title,
        lessonId: hostLessonId,
        activeSlideIdx: -1,
        phase: 'waiting',          // waiting | active | answering | locked | reveal | done
        attention: false,
        hostUid: auth.currentUser.uid,
        createdAt: serverTimestamp()
      });

      $('host-pin').textContent = hostPin;
      $('host-lesson-id').textContent = hostLessonId;
      const joinLink = `${window.location.origin}${window.location.pathname}?pin=${hostPin}`;
      $('host-join-link').textContent = joinLink;

      setMode('host');
      attachHostListeners(hostPin);
      renderHostSurface(null);
      syncPresentBadges();
    }

    async function hostStart() {
      if (!hostPin) return;
      hostActiveSlideIdx = 0;
      const slide = hostLesson?.slides?.[hostActiveSlideIdx] ?? null;
      hostPhase = isInteractiveSlide(slide) ? 'answering' : 'active';
      await updateDoc(sessionDocRef(hostPin), { activeSlideIdx: hostActiveSlideIdx, phase: hostPhase });
    }

    async function hostNext() {
      if (!hostPin) return;
      const nextIdx = hostActiveSlideIdx + 1;
      if (!hostLesson || nextIdx >= hostLesson.slides.length) {
        await updateDoc(sessionDocRef(hostPin), { phase: 'done' });
        alert('–ö—Ä–∞–π –Ω–∞ —É—Ä–æ–∫–∞.');
        return;
      }
      hostActiveSlideIdx = nextIdx;
      const slide = hostLesson?.slides?.[hostActiveSlideIdx] ?? null;
      hostPhase = isInteractiveSlide(slide) ? 'answering' : 'active';
      await updateDoc(sessionDocRef(hostPin), { activeSlideIdx: hostActiveSlideIdx, phase: hostPhase });
    }

    async function hostLock() { if (hostPin) await updateDoc(sessionDocRef(hostPin), { phase: 'locked' }); }
    async function hostReveal() { if (hostPin) await updateDoc(sessionDocRef(hostPin), { phase: 'reveal' }); }

    async function hostToggleAttention() {
      if (!hostPin) return;
      hostAttention = !hostAttention;
      await updateDoc(sessionDocRef(hostPin), { attention: hostAttention });
    }

    async function hostEnd() {
      if (!hostPin) return;
      await updateDoc(sessionDocRef(hostPin), { phase: 'done' });
      cleanupSubs();
      hostPin = null; hostLessonId = null; hostLesson = null;
      if (isPresent) await exitPresentMode();
      setMode('welcome');
    }

    function cleanupSubs() {
      Object.values(unsub).forEach(fn => { try { fn && fn(); } catch(e) {} });
      unsub = { session: null, participants: null, answers: null, answerMine: null };
    }

    async function ensureHostLessonLoaded(lessonId) {
      if (hostLesson && hostLessonId === lessonId) return;
      const cached = getCachedLesson(lessonId);
      if (cached) { hostLesson = cached; hostLessonId = lessonId; return; }
      const lSnap = await getDoc(lessonsDocRef(lessonId));
      const data = lSnap.data();
      if (data) {
        hostLesson = { title: data.title, theme: data.theme, slides: data.slides };
        hostLessonId = lessonId;
        cacheLesson(lessonId, hostLesson);
      }
    }

    function applyTheme(theme, bgEl, overlayEl) {
      const t = theme || { backgroundType: 'color', backgroundValue: '#111827', overlayOpacity: 0.45, fontPreset: 'large' };
      const type = t.backgroundType || 'color';
      const value = t.backgroundValue || '#111827';
      const op = Number(t.overlayOpacity ?? 0.45);

      if (type === 'image') {
        bgEl.style.backgroundImage = value ? `url('${value}')` : 'none';
        bgEl.style.backgroundColor = 'transparent';
      } else {
        bgEl.style.backgroundImage = 'none';
        bgEl.style.backgroundColor = value;
      }
      overlayEl.style.background = `rgba(0,0,0,${Math.max(0, Math.min(0.9, op))})`;
    }

    function attachHostListeners(pin) {
      cleanupSubs();

      unsub.session = onSnapshot(sessionDocRef(pin), async (snap) => {
        const d = snap.data();
        if (!d) return;

        hostLessonId = d.lessonId || hostLessonId;
        hostActiveSlideIdx = d.activeSlideIdx ?? -1;
        hostPhase = d.phase || 'waiting';
        hostAttention = !!d.attention;

        $('btn-host-attn').textContent = hostAttention ? 'Attention: ON' : 'Attention';

        if (hostLessonId) await ensureHostLessonLoaded(hostLessonId);

        // apply theme and preset to UI
        const scalePreset = hostLesson?.theme?.fontPreset || 'large';
        $('host-font-preset').value = scalePreset;
        $('present-font-preset').value = scalePreset;

        applyTheme(hostLesson?.theme, $('host-bg'), $('host-overlay'));
        applyTheme(hostLesson?.theme, $('present-bg'), $('present-overlay'));

        const slide = (hostLesson?.slides && hostActiveSlideIdx >= 0) ? hostLesson.slides[hostActiveSlideIdx] : null;

        $('host-slide-counter').textContent = hostLesson ? `${Math.max(hostActiveSlideIdx,0)+1} / ${hostLesson.slides.length}` : '‚Äî';
        $('host-slide-title').textContent = slide?.content?.title || '‚Äî';
        $('host-slide-meta').textContent = slide
          ? `layout: ${slide.layout || '‚Äî'} ‚Ä¢ phase: ${hostPhase} ‚Ä¢ attention: ${hostAttention ? 'ON' : 'OFF'}`
          : '‚Äî';

        renderHostSurface(slide);
        renderPresentSurface(slide);
        syncPresentBadges();

        // answers listener for current slide
        if (unsub.answers) { unsub.answers(); unsub.answers = null; }
        hostAnsweredCount = 0;

        if (slide && hostActiveSlideIdx >= 0 && isInteractiveSlide(slide)) {
          unsub.answers = onSnapshot(answersColRef(pin, hostActiveSlideIdx), (qsnap) => {
            const answers = qsnap.docs.map(x => ({ id: x.id, ...x.data() }));
            hostAnsweredCount = answers.length;
            $('stat-answered').textContent = String(answers.length);
            syncPresentBadges();
            renderStatsForSlide(slide, answers);
          });
        } else {
          $('stat-answered').textContent = '0';
          syncPresentBadges();
          $('stat-mcq').innerHTML = `<div class="muted font-bold">‚Äî</div>`;
          $('stat-short').innerHTML = `<div class="muted font-bold">‚Äî</div>`;
          $('stat-labeling').textContent = '‚Äî';
        }
      });

      unsub.participants = onSnapshot(participantsColRef(pin), (snap) => {
        hostParticipantsCount = snap.size;
        $('stat-participants').textContent = String(snap.size);
        syncPresentBadges();
      });
    }

    function renderHostSurface(slide) {
      $('host-slide-surface').innerHTML = renderSlideHTML(slide, false);
    }
    function renderPresentSurface(slide) {
      $('present-surface').innerHTML = renderSlideHTML(slide, true);
    }

    function renderSlideHTML(slide, big) {
      const theme = hostLesson?.theme || demoLesson.theme;
      const scale = getFontScale(theme);

      if (!slide) {
        return `
          <div class="slide-card">
            <div class="${big ? 'text-4xl' : 'text-xl'} font-black">–°—Ç–∞—Ä—Ç–∏—Ä–∞–π —Å–µ—Å–∏—è –∏ –Ω–∞—Ç–∏—Å–Ω–∏ Start.</div>
            <div class="muted font-bold mt-3 ${big ? 'text-xl' : ''}">–£—á–µ–Ω–∏—Ü–∏—Ç–µ —â–µ –≤–∏–∂–¥–∞—Ç —Å–∞–º–æ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏—Ç–µ –¥–µ–π–Ω–æ—Å—Ç–∏.</div>
          </div>
        `;
      }

      // Student-only slide: presenter hint
      if (slide.visibility === 'students') {
        const titleSize = big ? `text-[${Math.round(64*scale)}px]` : 'text-3xl';
        const bodyPx = Math.round((big ? 34 : 18) * scale);
        return `
          <div class="slide-card">
            <div class="slide-title ${big ? '' : 'text-3xl'}" style="${big ? `font-size:${Math.round(72*scale)}px;` : ''}">${escapeHtml(slide.content?.title || '–î–µ–π–Ω–æ—Å—Ç')}</div>
            <div class="slide-text mt-5" style="font-size:${bodyPx}px;">${escapeHtml(slide.content?.text || '')}</div>
            <div class="muted font-black mt-6" style="font-size:${Math.round(26*scale)}px;">üë©‚Äçüéì –£—á–µ–Ω–∏—Ü–∏—Ç–µ –æ—Ç–≥–æ–≤–∞—Ä—è—Ç –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏.</div>
          </div>
        `;
      }

      // Host templates
      const layout = slide.layout || 'content';
      const c = slide.content || {};

      const titlePx = Math.round((big ? 72 : 44) * scale);
      const subPx   = Math.round((big ? 44 : 22) * scale);
      const textPx  = Math.round((big ? 40 : 18) * scale);

      if (layout === 'title') {
        return `
          <div class="slide-card" style="text-align:center;">
            <div class="slide-title" style="font-size:${titlePx}px;">${escapeHtml(c.title || '–ó–∞–≥–ª–∞–≤–∏–µ')}</div>
            ${c.subtitle ? `<div class="font-black mt-6" style="color: rgb(51 65 85); font-size:${subPx}px;">${escapeHtml(c.subtitle)}</div>` : ''}
          </div>
        `;
      }

      if (layout === 'content') {
        return `
          <div class="slide-card">
            <div class="slide-title" style="font-size:${Math.round((big ? 60 : 38)*scale)}px;">${escapeHtml(c.title || '–ó–∞–≥–ª–∞–≤–∏–µ')}</div>
            ${c.text ? `<div class="slide-text mt-6" style="font-size:${textPx}px;">${escapeHtml(c.text)}</div>` : ''}
            ${c.image ? `
              <div class="img-frame mt-8" style="height:${big ? '420px' : '280px'};">
                <img src="${escapeAttr(c.image)}" alt="">
              </div>` : ''}
          </div>
        `;
      }

      if (layout === 'split') {
        const side = c.splitSide || 'imageRight';
        const imgBlock = c.image ? `
          <div class="img-frame" style="height:${big ? '520px' : '340px'};">
            <img src="${escapeAttr(c.image)}" alt="">
          </div>` : `
          <div class="img-frame flex items-center justify-center" style="height:${big ? '520px' : '340px'};">
            <div class="muted font-black">–ù—è–º–∞ —Å–Ω–∏–º–∫–∞</div>
          </div>`;

        const textBlock = `
          <div class="slide-card" style="box-shadow:none; margin:0; max-width:none;">
            <div class="slide-title" style="font-size:${Math.round((big ? 60 : 38)*scale)}px;">${escapeHtml(c.title || '–ó–∞–≥–ª–∞–≤–∏–µ')}</div>
            ${c.text ? `<div class="slide-text mt-6" style="font-size:${textPx}px;">${escapeHtml(c.text)}</div>` : ''}
          </div>`;

        const left = side === 'imageLeft' ? imgBlock : textBlock;
        const right = side === 'imageLeft' ? textBlock : imgBlock;

        return `
          <div style="display:grid; grid-template-columns: ${big ? '1.05fr 0.95fr' : '1.1fr 0.9fr'}; gap:${big ? '24px' : '18px'}; align-items:center;">
            <div>${left}</div>
            <div>${right}</div>
          </div>
        `;
      }

      return `
        <div class="slide-card">
          <div class="slide-title" style="font-size:${Math.round((big ? 56 : 34)*scale)}px;">${escapeHtml(c.title || '–°–ª–∞–π–¥')}</div>
          <div class="slide-text mt-5" style="font-size:${textPx}px;">${escapeHtml(c.text || '')}</div>
        </div>
      `;
    }

    function renderStatsForSlide(slide, answers) {
      const kind = slide.interaction.kind;

      if (kind === 'mcq' || kind === 'multi') {
        const opts = slide.interaction.options || [];
        const counts = Array(opts.length).fill(0);

        for (const a of answers) {
          if (kind === 'mcq') {
            const idx = Number(a.answerIndex);
            if (!Number.isNaN(idx) && idx >= 0 && idx < counts.length) counts[idx]++;
          } else {
            const arr = Array.isArray(a.answerIndexes) ? a.answerIndexes : [];
            for (const x of arr) {
              const idx = Number(x);
              if (!Number.isNaN(idx) && idx >= 0 && idx < counts.length) counts[idx]++;
            }
          }
        }

        $('stat-mcq').innerHTML = opts.map((t, i) => {
          const correct = Array.isArray(slide.interaction.correct)
            ? slide.interaction.correct.includes(i)
            : (i === slide.interaction.correct);
          return `
            <div class="flex items-center justify-between">
              <div class="font-black ${correct ? 'text-emerald-700' : 'text-slate-700'}">${i+1}. ${escapeHtml(t)}${correct ? ' ‚úÖ' : ''}</div>
              <div class="font-black">${counts[i] || 0}</div>
            </div>
          `;
        }).join('');

        $('stat-short').innerHTML = `<div class="muted font-bold">‚Äî</div>`;
        $('stat-labeling').textContent = '‚Äî';
        return;
      }

      if (kind === 'short') {
        $('stat-mcq').innerHTML = `<div class="muted font-bold">‚Äî</div>`;
        const preview = answers.slice(0, 10).map(a => {
          const txt = (a.answerText ?? '').toString();
          return `<div class="p-2 rounded-xl bg-slate-50 border border-slate-200">
            <div class="text-xs font-black uppercase tracking-widest muted">${escapeHtml(a.name || a.id)}</div>
            <div class="font-black">${escapeHtml(txt) || '‚Äî'}</div>
          </div>`;
        }).join('');
        $('stat-short').innerHTML = preview || `<div class="muted font-bold">–ù—è–º–∞ –æ—Ç–≥–æ–≤–æ—Ä–∏ –æ—â–µ.</div>`;
        $('stat-labeling').textContent = '‚Äî';
        return;
      }

      if (kind === 'labeling') {
        $('stat-mcq').innerHTML = `<div class="muted font-bold">‚Äî</div>`;
        $('stat-short').innerHTML = `<div class="muted font-bold">‚Äî</div>`;
        $('stat-labeling').textContent = `${answers.length} –æ—Ç–≥–æ–≤–æ—Ä–∞ (–ø—Ä–µ–≥–ª–µ–¥ –ø–æ-–∫—ä—Å–Ω–æ)`;
        return;
      }
    }

    // === PRESENTATION MODE ===
    async function enterPresentMode() {
      if (isPresent) return;
      isPresent = true;
      document.body.classList.add('present');
      $('present-shell').classList.remove('hidden');

      try {
        if (!document.fullscreenElement) {
          await document.documentElement.requestFullscreen();
        }
      } catch (e) {}
      syncPresentBadges();
      renderPresentSurface((hostLesson?.slides && hostActiveSlideIdx >= 0) ? hostLesson.slides[hostActiveSlideIdx] : null);
    }

    async function exitPresentMode() {
      if (!isPresent) return;
      isPresent = false;
      document.body.classList.remove('present');
      $('present-shell').classList.add('hidden');
      try { if (document.fullscreenElement) await document.exitFullscreen(); } catch (e) {}
    }

    function syncPresentBadges() {
      $('present-pin').textContent = hostPin || '‚Äî';
      $('present-counter').textContent = hostLesson ? `${Math.max(hostActiveSlideIdx,0)+1} / ${hostLesson.slides.length}` : '‚Äî';
      $('present-answered').textContent = `${hostAnsweredCount}/${hostParticipantsCount}`;
    }

    // === STUDENT FLOW ===
    async function ensureStudentLessonLoaded(lessonId) {
      if (studentLesson && studentLessonId === lessonId) return;
      const cached = getCachedLesson(lessonId);
      if (cached) { studentLesson = cached; studentLessonId = lessonId; return; }
      const lSnap = await getDoc(lessonsDocRef(lessonId));
      const data = lSnap.data();
      if (data) {
        studentLesson = { title: data.title, theme: data.theme, slides: data.slides };
        studentLessonId = lessonId;
        cacheLesson(lessonId, studentLesson);
      }
    }

    async function studentJoin(pin) {
      await ensureAnonAuth();
      const name = $('student-name').value.trim() || '–£—á–µ–Ω–∏–∫';
      studentPin = pin;
      $('student-pin-active').textContent = pin;

      await setDoc(participantDocRef(pin, auth.currentUser.uid), { name, joinedAt: serverTimestamp(), score: 0 }, { merge: true });
      setMode('student');
      attachStudentListeners(pin);
      showStudentWaiting('–ì–ª–µ–¥–∞–π –µ–∫—Ä–∞–Ω–∞ –æ—Ç–ø—Ä–µ–¥‚Ä¶');
    }

    function attachStudentListeners(pin) {
      cleanupSubs();
      let lastSlideIdx = null;
      let lastSlideObj = null;
      let myAnswerCache = null;

      unsub.session = onSnapshot(sessionDocRef(pin), async (snap) => {
        const d = snap.data();
        if (!d) { showStudentWaiting('–°–µ—Å–∏—è—Ç–∞ –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–∞.'); return; }

        studentLessonId = d.lessonId || studentLessonId;
        studentActiveSlideIdx = d.activeSlideIdx ?? -1;
        studentPhase = d.phase || 'waiting';
        studentAttention = !!d.attention;

        if (studentPhase === 'done') { showStudentWaiting('–°–µ—Å–∏—è—Ç–∞ –ø—Ä–∏–∫–ª—é—á–∏. –ë–ª–∞–≥–æ–¥–∞—Ä—è!'); return; }
        if (studentAttention) {
          showStudentWaiting('üëÄ –í–Ω–∏–º–∞–Ω–∏–µ –∫—ä–º –µ–∫—Ä–∞–Ω–∞ –æ—Ç–ø—Ä–µ–¥‚Ä¶');
          return;
        }
        if (!studentLessonId) { showStudentWaiting('–ó–∞—Ä–µ–∂–¥–∞–º —É—Ä–æ–∫‚Ä¶'); return; }

        await ensureStudentLessonLoaded(studentLessonId);
        const slide = (studentLesson?.slides && studentActiveSlideIdx >= 0) ? studentLesson.slides[studentActiveSlideIdx] : null;

        lastSlideIdx = studentActiveSlideIdx;
        lastSlideObj = slide;

        if (!slide || !isInteractiveSlide(slide)) {
          const msg = studentPhase === 'waiting' ? '–û—á–∞–∫–≤–∞–º–µ —Å—Ç–∞—Ä—Ç‚Ä¶' : '–ì–ª–µ–¥–∞–π –µ–∫—Ä–∞–Ω–∞ –æ—Ç–ø—Ä–µ–¥‚Ä¶';
          showStudentWaiting(msg);
          return;
        }

        showStudentInteraction(slide, studentPhase, studentActiveSlideIdx);

        // subscribe to my answer for this slide
        if (unsub.answerMine) { unsub.answerMine(); unsub.answerMine = null; }
        myAnswerCache = null;

        unsub.answerMine = onSnapshot(answerDocRef(pin, studentActiveSlideIdx, auth.currentUser.uid), (aSnap) => {
          myAnswerCache = aSnap.exists() ? aSnap.data() : null;
          const exists = !!myAnswerCache;
          updateStudentSubmitState({ hasAnswer: exists, phase: studentPhase });
          $('student-sent').classList.toggle('hidden', !exists);
          updateStudentFeedback(slide, studentPhase, myAnswerCache);
        });
      });

      function updateStudentFeedback(slide, phase, myAnswer) {
        const fb = $('student-feedback');
        fb.classList.add('hidden');
        fb.classList.remove('bg-emerald-50','text-emerald-700','bg-rose-50','text-rose-700','bg-slate-100','text-slate-700');

        if (phase !== 'reveal') return;
        if (!myAnswer) return;

        const ok = isAnswerCorrect(slide, myAnswer);
        fb.textContent = ok ? '–í—è—Ä–Ω–æ ‚úÖ' : '–ì—Ä–µ—à–Ω–æ ‚ùå';
        fb.classList.add(ok ? 'bg-emerald-50' : 'bg-rose-50', ok ? 'text-emerald-700' : 'text-rose-700');
        fb.classList.remove('hidden');
      }
    }

    function showStudentWaiting(msg) {
      show('student-waiting');
      hide('student-interaction');
      $('student-waiting-msg').textContent = msg;
    }

    function updateStudentSubmitState({ hasAnswer, phase }) {
      const locked = (phase === 'locked' || phase === 'reveal');
      const btn = $('btn-student-submit');

      if (hasAnswer) {
        btn.textContent = '–ò–ó–ü–†–ê–¢–ï–ù–û ‚úÖ';
        btn.classList.add('disabled');
        return;
      }

      btn.textContent = locked ? '–ó–ê–ö–õ–Æ–ß–ï–ù–û üîí' : '–ü–æ—Ç–≤—ä—Ä–¥–∏';
      btn.classList.toggle('disabled', locked);
    }

    function showStudentInteraction(slide, phase, slideIdx) {
      hide('student-waiting');
      show('student-interaction');

      $('student-q-title').textContent = slide.content?.title || '–í—ä–ø—Ä–æ—Å';
      $('student-q-sub').textContent = slide.content?.text || '';
      $('student-phase').textContent = phase.toUpperCase();

      $('student-sent').classList.add('hidden');
      $('student-feedback').classList.add('hidden');
      const body = $('student-q-body');
      body.innerHTML = '';

      const locked = (phase === 'locked' || phase === 'reveal');
      updateStudentSubmitState({ hasAnswer: false, phase });

      const kind = slide.interaction.kind;

      if (kind === 'mcq') {
        const opts = slide.interaction.options || [];
        body.innerHTML = `<div class="space-y-3" id="mcq-list">
          ${opts.map((t, i) => `<button class="opt w-full text-left" data-idx="${i}">${i+1}. ${escapeHtml(t)}</button>`).join('')}
        </div>`;
        let selected = null;
        body.querySelectorAll('.opt').forEach(btn => {
          btn.addEventListener('click', () => {
            if (locked) return;
            body.querySelectorAll('.opt').forEach(x => x.classList.remove('selected'));
            btn.classList.add('selected');
            selected = Number(btn.dataset.idx);
          });
        });
        $('btn-student-submit').onclick = () => submitStudentAnswer(slide, slideIdx, { answerIndex: selected });
        return;
      }

      if (kind === 'multi') {
        const opts = slide.interaction.options || [];
        body.innerHTML = `<div class="space-y-3" id="multi-list">
          ${opts.map((t, i) => `
            <button class="opt w-full text-left flex items-center justify-between" data-idx="${i}">
              <span>${i+1}. ${escapeHtml(t)}</span>
              <span class="muted font-black text-sm">‚ñ°</span>
            </button>
          `).join('')}
        </div>`;
        const selectedSet = new Set();
        body.querySelectorAll('.opt').forEach(btn => {
          btn.addEventListener('click', () => {
            if (locked) return;
            const idx = Number(btn.dataset.idx);
            if (selectedSet.has(idx)) {
              selectedSet.delete(idx);
              btn.classList.remove('selected');
              btn.querySelector('span:last-child').textContent = '‚ñ°';
            } else {
              selectedSet.add(idx);
              btn.classList.add('selected');
              btn.querySelector('span:last-child').textContent = '‚úì';
            }
          });
        });
        $('btn-student-submit').onclick = () => submitStudentAnswer(slide, slideIdx, { answerIndexes: Array.from(selectedSet).sort((a,b)=>a-b) });
        return;
      }

      if (kind === 'short') {
        body.innerHTML = `<div class="space-y-2">
          <label class="text-xs font-black uppercase tracking-widest muted">–¢–≤–æ—è—Ç –æ—Ç–≥–æ–≤–æ—Ä</label>
          <input id="short-input" class="w-full p-4 rounded-2xl border-2 border-slate-200 font-black outline-none focus:border-sky-600" placeholder="–ù–∞–ø–∏—à–∏..." />
        </div>`;
        $('btn-student-submit').onclick = () => submitStudentAnswer(slide, slideIdx, { answerText: ($('short-input').value ?? '') });
        return;
      }

      if (kind === 'labeling') {
        const img = slide.content?.image || '';
        const targets = slide.interaction.targets || [];
        const labels = targets.map(t => t.text);

        body.innerHTML = `
          <div class="space-y-4">
            <div class="relative w-full rounded-2xl overflow-hidden border border-slate-200 bg-slate-50" style="min-height: 260px;">
              ${img ? `<img src="${escapeAttr(img)}" class="w-full max-h-[360px] object-contain block" alt="">` : `<div class="p-6 muted font-black">–ù—è–º–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div>`}
              <div id="label-layer" class="absolute inset-0"></div>
            </div>
            <div class="muted font-bold text-sm">–ò–∑–±–µ—Ä–∏ –µ—Ç–∏–∫–µ—Ç –∏ –Ω–∞—Ç–∏—Å–Ω–∏ —Ü–µ–ª (–∫—Ä—ä–≥—á–µ).</div>
            <div id="labels-pool" class="flex gap-2 overflow-x-auto pb-2"></div>
          </div>
        `;

        const layer = $('label-layer');
        const pool = $('labels-pool');

        let selectedLabel = null;
        const placements = {};

        layer.innerHTML = targets.map((t, i) => `<div class="label-target" id="target-${i}" style="left:${t.x}%; top:${t.y}%;">${i+1}</div>`).join('');
        pool.innerHTML = labels.map((txt) => `<div class="label-chip" data-label="${escapeAttr(txt)}">${escapeHtml(txt)}</div>`).join('');

        pool.querySelectorAll('.label-chip').forEach(chip => {
          chip.addEventListener('click', () => {
            if (locked) return;
            pool.querySelectorAll('.label-chip').forEach(x => x.classList.remove('selected'));
            chip.classList.add('selected');
            selectedLabel = chip.getAttribute('data-label');
          });
        });

        targets.forEach((t, i) => {
          const el = $('target-' + i);
          el.addEventListener('click', () => {
            if (locked) return;
            if (!selectedLabel) return;

            placements[i] = selectedLabel;
            el.textContent = selectedLabel;
            el.classList.add('filled');

            const chip = pool.querySelector(`.label-chip[data-label="${cssEscape(selectedLabel)}"]`);
            if (chip) chip.classList.add('placed');

            selectedLabel = null;
            pool.querySelectorAll('.label-chip').forEach(x => x.classList.remove('selected'));
          });
        });

        $('btn-student-submit').onclick = () => submitStudentAnswer(slide, slideIdx, { labelingMap: placements });
        return;
      }
    }

    function normalizeShort(s, caseSensitive) {
      const t = (s ?? '').toString().trim();
      return caseSensitive ? t : t.toLowerCase();
    }

    function isAnswerCorrect(slide, ans) {
      const kind = slide?.interaction?.kind;
      if (!kind) return false;

      if (kind === 'mcq') {
        const correct = Number(slide.interaction.correct);
        const given = Number(ans.answerIndex);
        return Number.isFinite(correct) && Number.isFinite(given) && correct === given;
      }

      if (kind === 'multi') {
        const correct = Array.isArray(slide.interaction.correct) ? slide.interaction.correct.map(Number).filter(Number.isFinite).sort((a,b)=>a-b) : [];
        const given = Array.isArray(ans.answerIndexes) ? ans.answerIndexes.map(Number).filter(Number.isFinite).sort((a,b)=>a-b) : [];
        if (correct.length !== given.length) return false;
        for (let i=0;i<correct.length;i++) if (correct[i] !== given[i]) return false;
        return true;
      }

      if (kind === 'short') {
        const cs = !!slide.interaction.caseSensitive;
        const correct = normalizeShort(slide.interaction.correctText, cs);
        const given = normalizeShort(ans.answerText, cs);
        return !!correct && correct === given;
      }

      if (kind === 'labeling') {
        const targets = slide.interaction.targets || [];
        const map = ans.labelingMap || {};
        // correct if every target index is mapped correctly
        for (let i=0;i<targets.length;i++) {
          const expected = (targets[i]?.text ?? '').toString();
          const got = (map[i] ?? map[String(i)] ?? '').toString();
          if (!expected || got !== expected) return false;
        }
        return targets.length > 0;
      }

      return false;
    }

    async function submitStudentAnswer(slide, slideIdx, payload) {
      const pin = studentPin;
      if (!pin || !auth.currentUser) return;

      const kind = slide.interaction.kind;
      if (kind === 'mcq') {
        if (payload.answerIndex === null || payload.answerIndex === undefined || Number.isNaN(Number(payload.answerIndex))) { alert('–ò–∑–±–µ—Ä–∏ –æ—Ç–≥–æ–≤–æ—Ä.'); return; }
      }
      if (kind === 'multi') {
        if (!Array.isArray(payload.answerIndexes) || payload.answerIndexes.length === 0) { alert('–ò–∑–±–µ—Ä–∏ –ø–æ–Ω–µ 1 –æ—Ç–≥–æ–≤–æ—Ä.'); return; }
      }
      if (kind === 'short') {
        const t = (payload.answerText ?? '').toString().trim();
        if (!t) { alert('–ù–∞–ø–∏—à–∏ –æ—Ç–≥–æ–≤–æ—Ä.'); return; }
      }
      if (kind === 'labeling') {
        const map = payload.labelingMap || {};
        if (Object.keys(map).length === 0) { alert('–ü–æ—Å—Ç–∞–≤–∏ –ø–æ–Ω–µ 1 –µ—Ç–∏–∫–µ—Ç.'); return; }
      }

      const sSnap = await getDoc(sessionDocRef(pin));
      const sData = sSnap.data();
      const phase = sData?.phase || 'waiting';
      const activeIdx = sData?.activeSlideIdx;
      const attn = !!sData?.attention;

      if (attn) { alert('–í–Ω–∏–º–∞–Ω–∏–µ –∫—ä–º –µ–∫—Ä–∞–Ω–∞ –æ—Ç–ø—Ä–µ–¥.'); return; }
      if (phase === 'locked' || phase === 'reveal') { alert('–ó–∞–∫–ª—é—á–µ–Ω–æ.'); return; }
      if (activeIdx !== slideIdx) { alert('–°–ª–∞–π–¥—ä—Ç –≤–µ—á–µ –µ —Å–º–µ–Ω–µ–Ω.'); return; }

      const name = ($('student-name').value.trim() || '–£—á–µ–Ω–∏–∫');

      await setDoc(answerDocRef(pin, slideIdx, auth.currentUser.uid), {
        uid: auth.currentUser.uid,
        name,
        kind,
        ...payload,
        answeredAt: serverTimestamp()
      }, { merge: true });

      $('student-sent').classList.remove('hidden');
      updateStudentSubmitState({ hasAnswer: true, phase });
    }

    // === UTIL ===
    function escapeHtml(s) {
      return (s ?? '').toString()
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }
    function escapeAttr(s) { return escapeHtml(s); }
    function cssEscape(s) { return (s ?? '').toString().replaceAll('\\', '\\\\').replaceAll('"', '\\"'); }

    // === WIRE UI ===
    $('btn-load-demo').addEventListener('click', () => {
      localStorage.setItem('lm_demo_lesson', JSON.stringify(demoLesson));
      alert('Demo —É—Ä–æ–∫—ä—Ç –µ –∑–∞—Ä–µ–¥–µ–Ω –ª–æ–∫–∞–ª–Ω–æ. –ù–∞—Ç–∏—Å–Ω–∏ –í—Ö–æ–¥.');
    });

    $('btn-host-login').addEventListener('click', hostLogin);
    $('btn-host-start').addEventListener('click', hostStart);
    $('btn-host-next').addEventListener('click', hostNext);
    $('btn-host-lock').addEventListener('click', hostLock);
    $('btn-host-reveal').addEventListener('click', hostReveal);
    $('btn-host-attn').addEventListener('click', hostToggleAttention);
    $('btn-host-end').addEventListener('click', hostEnd);

    $('btn-host-full').addEventListener('click', async () => {
      if (!isPresent) await enterPresentMode();
      else await exitPresentMode();
    });

    $('present-next').addEventListener('click', hostNext);
    $('present-lock').addEventListener('click', hostLock);
    $('present-reveal').addEventListener('click', hostReveal);
    $('present-attn').addEventListener('click', hostToggleAttention);
    $('present-exit').addEventListener('click', exitPresentMode);

    function onPresetChange(preset) {
      // Update lesson theme preset in Firestore (lesson doc) so both host/present re-render consistently
      if (!hostLessonId) return;
      if (!hostLesson) hostLesson = demoLesson;
      hostLesson.theme = hostLesson.theme || {};
      hostLesson.theme.fontPreset = preset;
      cacheLesson(hostLessonId, hostLesson);
      // also persist to lesson doc for future joins (optional)
      setDoc(lessonsDocRef(hostLessonId), { theme: hostLesson.theme }, { merge: true }).catch(()=>{});
      // re-render immediately
      const slide = (hostLesson?.slides && hostActiveSlideIdx >= 0) ? hostLesson.slides[hostActiveSlideIdx] : null;
      renderHostSurface(slide);
      renderPresentSurface(slide);
    }

    $('host-font-preset').addEventListener('change', (e) => {
      $('present-font-preset').value = e.target.value;
      onPresetChange(e.target.value);
    });
    $('present-font-preset').addEventListener('change', (e) => {
      $('host-font-preset').value = e.target.value;
      onPresetChange(e.target.value);
    });

    $('btn-student-join').addEventListener('click', async () => {
      const pin = $('student-pin').value.trim();
      if (!pin) return alert('–í—ä–≤–µ–¥–∏ PIN.');
      await ensureAnonAuth();
      await studentJoin(pin);
    });

    $('btn-student-leave').addEventListener('click', async () => {
      cleanupSubs();
      try { await signOut(auth); } catch(e) {}
      studentPin = null;
      studentLessonId = null;
      studentLesson = null;
      setMode('welcome');
    });

    window.addEventListener('DOMContentLoaded', () => {
      setMode('welcome');
      setStatus('ready');
      const p = new URLSearchParams(window.location.search).get('pin');
      if (p) $('student-pin').value = p;
    });
  </script>
</body>
</html>


